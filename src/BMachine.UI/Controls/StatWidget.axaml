<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:shapes="using:Avalonia.Controls.Shapes"
             mc:Ignorable="d" d:DesignWidth="150" d:DesignHeight="180"
             x:Class="BMachine.UI.Controls.StatWidget"
             x:Name="Root">
    
    <UserControl.Styles>
        <Style Selector="Button:pointerover /template/ ContentPresenter">
            <Setter Property="Background" Value="Transparent" />
        </Style>
        <Style Selector="Button:pressed /template/ ContentPresenter">
            <Setter Property="Background" Value="Transparent" />
        </Style>
    </UserControl.Styles>

    <Panel>
        <!-- Main Click Area -->
        <Button Classes="Clear" 
                Command="{Binding #Root.Command}"
                Padding="0" 
                BorderThickness="0" 
                Background="Transparent"
                HorizontalAlignment="Stretch"
                VerticalAlignment="Stretch"
                HorizontalContentAlignment="Stretch"
                VerticalContentAlignment="Stretch"
                Cursor="Hand">
        <Border Classes="Card" Background="{DynamicResource CardBackgroundBrush}" CornerRadius="12" Padding="15,8,15,12">
            <Panel>
                <StackPanel Spacing="10" HorizontalAlignment="Center" VerticalAlignment="Center"
                            IsVisible="{Binding #Root.IsCircularMode}">
                    
                    <!-- Circular Progress Container -->
                    <Panel Width="80" Height="80">
                        <!-- Background Ring -->
                        <shapes:Arc Width="80" Height="80"
                             StartAngle="0" SweepAngle="360"
                             Stroke="#33FFFFFF" StrokeThickness="6"/>
                        
                        <!-- Progress Ring (Calculated Arc) -->
                        <shapes:Arc x:Name="PART_ProgressArc" 
                             Width="80" Height="80"
                             StartAngle="-90" 
                             SweepAngle="{Binding #Root.SweepAngle}"
                             Stroke="{Binding #Root.Color}" 
                             StrokeThickness="6"
                             StrokeLineCap="Round">
                        </shapes:Arc>
                             
                        <!-- Value Text -->
                        <TextBlock Text="{Binding #Root.Value}"
                                   FontSize="22"
                                   FontWeight="Bold"
                                   Foreground="{DynamicResource TextPrimaryBrush}"
                                   HorizontalAlignment="Center"
                                   VerticalAlignment="Center"
                                   Margin="0,0,0,18"/>
                                   
                         <!-- Open Window Button (Small, Bottom of Circle) -->
                         <Button Command="{Binding #Root.WindowCommand}"
                                 IsVisible="{Binding #Root.WindowCommand, Converter={x:Static ObjectConverters.IsNotNull}}"
                                 VerticalAlignment="Bottom" HorizontalAlignment="Center"
                                 Margin="0,0,0,8"
                                 Width="16" Height="16"
                                 Background="Transparent" BorderThickness="0" Padding="2"
                                 ToolTip.Tip="Open in New Window" Classes="Clear">
                             <shapes:Path Data="{StaticResource IconOpenWindow}" 
                                          Fill="{Binding #Root.Color}"
                                          Stretch="Uniform" Opacity="0.8"/>
                         </Button>
                                   
                         <!-- Icon -->
                         <shapes:Path Data="{Binding #Root.Icon}"
                               Width="24" Height="24"
                               Stretch="Uniform"
                               Fill="{Binding #Root.Color}"
                               VerticalAlignment="Top"
                               HorizontalAlignment="Center"
                               Margin="0,15,0,0"
                               IsVisible="{Binding #Root.ShowIcon}"/>
                    </Panel>
                    
                    <TextBlock Text="{Binding #Root.Label}"
                               Foreground="{DynamicResource TextSecondaryBrush}"
                               FontSize="12"
                               FontWeight="Bold"
                               HorizontalAlignment="Center"
                               TextAlignment="Center"/>
                </StackPanel>

                <!-- MODE: BAR (New Design) -->
                <Grid RowDefinitions="24,*,Auto" 
                      IsVisible="{Binding #Root.IsBarMode}">
                    
                    <!-- Header: Label + Open Button (Right aligned) -->
                    <Grid Grid.Row="0" ColumnDefinitions="*,Auto" VerticalAlignment="Center">
                        <TextBlock Text="{Binding #Root.Label}"
                                   Foreground="{DynamicResource TextSecondaryBrush}"
                                   FontSize="11"
                                   FontWeight="Bold"
                                   VerticalAlignment="Center"
                                   TextTrimming="CharacterEllipsis"/>
                        
                        <!-- Open Window Button (Top Right) -->
                        <Button Grid.Column="1" 
                                Command="{Binding #Root.WindowCommand}"
                                IsVisible="{Binding #Root.WindowCommand, Converter={x:Static ObjectConverters.IsNotNull}}"
                                Width="20" Height="20"
                                Background="Transparent" BorderThickness="0" Padding="4"
                                ToolTip.Tip="Open in New Window" Classes="Clear"
                                Margin="4,0,-6,0"
                                VerticalAlignment="Center"
                                Cursor="Hand">
                            <shapes:Path Data="{StaticResource IconOpenWindow}" 
                                         Fill="{Binding #Root.Color}"
                                         Stretch="Uniform" Opacity="0.8"/>
                        </Button>
                    </Grid>

                    <!-- Main Value -->
                    <TextBlock Grid.Row="1" 
                               Text="{Binding #Root.Value}"
                               FontSize="32"
                               FontWeight="Bold"
                               Foreground="{DynamicResource TextPrimaryBrush}"
                               VerticalAlignment="Center"
                               Margin="0,0,0,4"/>

                    <!-- Progress Bar -->
                    <ProgressBar Grid.Row="2"
                                 Value="{Binding #Root.Percentage}"
                                 Maximum="1" Minimum="0"
                                 Height="4"
                                 CornerRadius="2"
                                 Background="#22FFFFFF"
                                 Foreground="{Binding #Root.Color}"
                                 VerticalAlignment="Bottom"/>
                </Grid>
            </Panel>
        </Border>
        </Button>
    </Panel>
</UserControl>
