<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:controls="clr-namespace:BMachine.UI.Controls"
             xmlns:views="using:BMachine.UI.Views"
             xmlns:shapes="using:Avalonia.Controls.Shapes"
             mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="800"
             x:Class="BMachine.UI.Views.DashboardView"
             xmlns:vm="using:BMachine.UI.ViewModels"
             x:Name="Root">

    <UserControl.DataTemplates>
        <TreeDataTemplate DataType="{x:Type vm:BatchNodeItem}" ItemsSource="{Binding Children}">
            <StackPanel x:Name="NodePanel" Orientation="Horizontal" Spacing="4" Background="Transparent" Margin="-28,-2,0,-2"
                        PointerPressed="OnNodePointerPressed">
                <!-- Icons Removed per User Request for Compact Look -->
                
                <Button Command="{Binding CopyPathCommand}" 
                        Classes="plainLink"
                        PointerPressed="OnNodePointerPressed"
                        Height="16" MinHeight="0"
                        Background="Transparent" BorderThickness="0" Padding="0" Margin="0" 
                        Cursor="Hand" ToolTip.Tip="Left-Click: Copy Path | Right-Click: Expand">
                    <TextBlock Text="{Binding Name}" FontSize="10" Foreground="{DynamicResource TextPrimaryBrush}" VerticalAlignment="Center" TextTrimming="CharacterEllipsis" MaxWidth="180"/>
                </Button>
            </StackPanel>
        </TreeDataTemplate>
    </UserControl.DataTemplates>
             
    <UserControl.Styles>
        <!-- Custom Style for Plain Link Button (No Hover) -->
        <Style Selector="Button.plainLink">
            <Setter Property="Background" Value="Transparent"/>
        </Style>
        <Style Selector="Button.plainLink:pointerover /template/ ContentPresenter">
            <Setter Property="Background" Value="Transparent"/>
        </Style>
        <Style Selector="Button.plainLink:pressed /template/ ContentPresenter">
            <Setter Property="Background" Value="Transparent"/>
        </Style>

        <!-- Custom Style for Pill Menu Flyout -->
        <Style Selector="FlyoutPresenter">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="CornerRadius" Value="18"/>
            <Setter Property="MinWidth" Value="0"/>
            <Setter Property="Margin" Value="0,4,0,0"/>
        </Style>
    </UserControl.Styles>

    
    <Grid ColumnDefinitions="Auto, *, 0, Auto">
        <!-- COMPACT SIDEBAR (LEFT) -->
        <Border Grid.Column="0" 
                Background="{DynamicResource BackgroundBrush}"
                BorderThickness="0,0,1,0"
                BorderBrush="{DynamicResource CardBorderBrush}"
                Width="50">
            <Border.Effect>
                <DropShadowEffect BlurRadius="8" OffsetX="2" OffsetY="0" Color="#20000000" Opacity="1"/>
            </Border.Effect>
            <Grid RowDefinitions="Auto, *, Auto">
                <!-- Profile Picture (Top) -->
                <Border Grid.Row="0" Width="25" Height="25" CornerRadius="6" 
                        Background="{DynamicResource CardBackgroundBrush}" 
                        ClipToBounds="True" Margin="10,16,10,16"
                        BorderBrush="{DynamicResource CardBorderBrush}" BorderThickness="1">
                    <Panel>
                        <shapes:Path Data="{StaticResource IconUser}" Width="16" Height="16" 
                                   Fill="{DynamicResource TextSecondaryBrush}" Stretch="Uniform" 
                                   HorizontalAlignment="Center" VerticalAlignment="Center"
                                   IsVisible="{Binding UserAvatar, Converter={x:Static ObjectConverters.IsNull}}"/>
                        <Image Source="{Binding UserAvatar}" Stretch="UniformToFill"
                               IsVisible="{Binding UserAvatar, Converter={x:Static ObjectConverters.IsNotNull}}"/>
                    </Panel>
                </Border>
                
                <!-- Middle Spacer -->
                <Border Grid.Row="1"/>
                
                <!-- Bottom Buttons -->
                <StackPanel Grid.Row="2" Spacing="12" HorizontalAlignment="Center" Margin="0,0,0,16">
                    <!-- Terminal/Log Button -->
                    <ToggleButton Command="{Binding ToggleLogPanelCommand}" 
                                  IsChecked="{Binding IsLogPanelOpen, Mode=OneWay}"
                                  Width="36" Height="36" Padding="0"
                                  Background="Transparent" BorderThickness="0"
                                  CornerRadius="8" Cursor="Hand"
                                  ToolTip.Tip="Terminal">
                        <ToggleButton.Styles>
                            <Style Selector="ToggleButton:pointerover /template/ ContentPresenter#PART_ContentPresenter">
                                <Setter Property="Background" Value="{DynamicResource CardBackgroundBrush}"/>
                            </Style>
                        </ToggleButton.Styles>
                        <shapes:Path Data="M19,3H14.82C14.4,1.84 13.3,1 12,1C10.7,1 9.6,1.84 9.18,3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3M12,3A1,1 0 0,1 13,4A1,1 0 0,1 12,5A1,1 0 0,1 11,4A1,1 0 0,1 12,3M7,7H17V9H7V7M7,11H17V13H7V11M7,15H17V17H7V15Z" 
                                     Width="16" Height="16" Stretch="Uniform" Fill="{DynamicResource TextPrimaryBrush}" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                    </ToggleButton>
                    
                    <!-- Settings Button -->
                    <Button Click="OnSettingsClick" 
                            Width="36" Height="36" Padding="0" 
                            Background="Transparent" BorderThickness="0" 
                            CornerRadius="8" Cursor="Hand" 
                            ToolTip.Tip="Settings">
                        <Button.Styles>
                            <Style Selector="Button:pointerover /template/ ContentPresenter#PART_ContentPresenter">
                                <Setter Property="Background" Value="{DynamicResource CardBackgroundBrush}"/>
                            </Style>
                        </Button.Styles>
                        <shapes:Path Data="{StaticResource IconSettings}" Width="16" Height="16" Stretch="Uniform" Fill="{DynamicResource TextPrimaryBrush}"/>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>
        
        <!-- Vertical Separator (like terminal) -->
        <Border Grid.Column="0" Width="1" Background="#33FFFFFF" HorizontalAlignment="Right" Margin="0" ZIndex="10"/>
        
        <!-- MAIN DASHBOARD AREA (Content) -->
        <Grid Grid.Column="1" RowDefinitions="Auto, *" MinWidth="479">
            <!-- NAVIGATION BAR (Horizontal, at top) -->
            <Border Grid.Row="0" HorizontalAlignment="Center" Background="{DynamicResource CardBackgroundBrush}" 
                    CornerRadius="12" Padding="4" Margin="12,12,12,6" BorderBrush="{DynamicResource CardBorderBrush}" BorderThickness="1">
                <StackPanel Orientation="Horizontal" Spacing="0">
                    <!-- GDrive Tab -->
                    <RadioButton GroupName="NavTabs" IsChecked="{Binding IsGdriveTabSelected}"
                                 IsVisible="{Binding IsGdriveVisible}"
                                 Padding="0" Width="{Binding NavButtonWidth}" Height="{Binding NavButtonHeight}"
                                 Foreground="{DynamicResource TextPrimaryBrush}" FontWeight="Bold" Opacity="0.6" Cursor="Hand"
                                 VerticalContentAlignment="Center" HorizontalContentAlignment="Center">
                        <PathIcon Data="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z" Width="{Binding NavFontSize}" Height="{Binding NavFontSize}" />
                        <RadioButton.Template>
                            <ControlTemplate>
                                <Border Background="{TemplateBinding Background}" CornerRadius="{Binding DataContext.NavCornerRadiusStruct, ElementName=Root}" Padding="{TemplateBinding Padding}">
                                    <ContentPresenter Content="{TemplateBinding Content}" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                </Border>
                            </ControlTemplate>
                        </RadioButton.Template>
                        <RadioButton.Styles>
                            <Style Selector="RadioButton">
                                <Setter Property="Background" Value="Transparent"/>
                                <Setter Property="Transitions">
                                    <Transitions>
                                        <BrushTransition Property="Background" Duration="0:0:0.15"/>
                                        <BrushTransition Property="Foreground" Duration="0:0:0.15"/>
                                    </Transitions>
                                </Setter>
                            </Style>
                            <Style Selector="RadioButton:checked">
                                <Setter Property="Background" Value="{DynamicResource AccentBlueBrush}"/>
                                <Setter Property="Foreground" Value="White"/>
                                <Setter Property="Opacity" Value="1.0"/>
                            </Style>
                        </RadioButton.Styles>
                    </RadioButton>

                    <!-- Pixelcut Tab -->
                    <RadioButton GroupName="NavTabs" IsChecked="{Binding IsPixelcutTabSelected}"
                                 IsVisible="{Binding IsPixelcutVisible}"
                                 Padding="0" Width="{Binding NavButtonWidth}" Height="{Binding NavButtonHeight}"
                                 Foreground="{DynamicResource TextPrimaryBrush}" FontWeight="Bold" Opacity="0.6" Cursor="Hand"
                                 VerticalContentAlignment="Center" HorizontalContentAlignment="Center">
                        <PathIcon Data="M20,6 L18.59,4.59 L14.73,8.45 L13.32,7.04 L17.18,3.18 L15.76,1.76 L13.64,3.88 C13.06,3.33 12.29,3 11.5,3 C9.57,3 8,4.57 8,6.5 C8,7.29 8.27,8.03 8.74,8.63 L6,11.37 C5.53,10.9 5.25,10.27 5.25,9.58 C5.25,8.13 6.42,6.96 7.88,6.96 C8.4,6.96 8.82,6.54 8.82,6.02 C8.82,5.5 8.4,5.08 7.88,5.08 C5.39,5.08 3.37,7.1 3.37,9.58 C3.37,10.79 3.86,11.9 4.66,12.71 L2.25,15.12 L3.66,16.54 L7.52,12.68 L8.93,14.09 L5.07,17.95 L6.49,19.36 L9.29,16.56 C10.1,17.37 11.21,17.86 12.42,17.86 C14.91,17.86 16.92,15.84 16.92,13.36 C16.92,12.83 16.5,12.41 15.98,12.41 C15.46,12.41 15.04,12.83 15.04,13.36 C15.04,14.81 13.86,15.98 12.42,15.98 C11.72,15.98 11.09,15.7 10.63,15.22 L13.37,12.48 C13.97,12.95 14.71,13.23 15.5,13.23 C17.43,13.23 19,11.66 19,9.73 C19,8.94 18.73,8.2 18.26,7.6 L20.38,5.48 L20.4,5.5 L20,6 M11.5,4.88 C12.4,4.88 13.12,5.6 13.12,6.5 C13.12,7.4 12.4,8.12 11.5,8.12 C10.6,8.12 9.88,7.4 9.88,6.5 C9.88,5.6 10.6,4.88 11.5,4.88 M15.5,11.35 C14.6,11.35 13.88,10.63 13.88,9.73 C13.88,8.83 14.6,8.11 15.5,8.11 C16.4,8.11 17.12,8.83 17.12,9.73 C17.12,10.63 16.4,11.35 15.5,11.35" Width="{Binding NavFontSize}" Height="{Binding NavFontSize}" />
                        <RadioButton.Template>
                            <ControlTemplate>
                                <Border Background="{TemplateBinding Background}" CornerRadius="{Binding DataContext.NavCornerRadiusStruct, ElementName=Root}" Padding="{TemplateBinding Padding}">
                                    <ContentPresenter Content="{TemplateBinding Content}" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                </Border>
                            </ControlTemplate>
                        </RadioButton.Template>
                        <RadioButton.Styles>
                            <Style Selector="RadioButton">
                                <Setter Property="Background" Value="Transparent"/>
                                <Setter Property="Transitions">
                                    <Transitions>
                                        <BrushTransition Property="Background" Duration="0:0:0.15"/>
                                        <BrushTransition Property="Foreground" Duration="0:0:0.15"/>
                                    </Transitions>
                                </Setter>
                            </Style>
                            <Style Selector="RadioButton:checked">
                                <Setter Property="Background" Value="{DynamicResource AccentBlueBrush}"/>
                                <Setter Property="Foreground" Value="White"/>
                                <Setter Property="Opacity" Value="1.0"/>
                            </Style>
                        </RadioButton.Styles>
                    </RadioButton>

                    <!-- Dashboard Tab -->
                    <RadioButton GroupName="NavTabs" IsChecked="{Binding IsDashboardTabSelected, Mode=TwoWay}"
                                 Padding="0" Width="{Binding NavButtonWidth}" Height="{Binding NavButtonHeight}"
                                 Foreground="{DynamicResource TextPrimaryBrush}" FontWeight="Bold" Opacity="0.6" Cursor="Hand"
                                 VerticalContentAlignment="Center" HorizontalContentAlignment="Center">
                        <PathIcon Data="M10,20V14H14V20H19V12H22L12,3L2,12H5V20H10Z" Width="{Binding NavFontSize}" Height="{Binding NavFontSize}" />
                        <RadioButton.Template>
                            <ControlTemplate>
                                <Border Background="{TemplateBinding Background}" CornerRadius="{Binding DataContext.NavCornerRadiusStruct, ElementName=Root}" Padding="{TemplateBinding Padding}">
                                    <ContentPresenter Content="{TemplateBinding Content}" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                </Border>
                            </ControlTemplate>
                        </RadioButton.Template>
                        <RadioButton.Styles>
                            <Style Selector="RadioButton">
                                <Setter Property="Background" Value="Transparent"/>
                                <Setter Property="Transitions">
                                    <Transitions>
                                        <BrushTransition Property="Background" Duration="0:0:0.15"/>
                                        <BrushTransition Property="Foreground" Duration="0:0:0.15"/>
                                    </Transitions>
                                </Setter>
                            </Style>
                            <Style Selector="RadioButton:checked">
                                <Setter Property="Background" Value="{DynamicResource AccentBlueBrush}"/>
                                <Setter Property="Foreground" Value="White"/>
                                <Setter Property="Opacity" Value="1.0"/>
                            </Style>
                        </RadioButton.Styles>
                    </RadioButton>

                    <!-- Batch Tab -->
                    <RadioButton GroupName="NavTabs" IsChecked="{Binding IsBatchTabSelected}"
                                 IsVisible="{Binding IsBatchVisible}"
                                 Padding="0" Width="{Binding NavButtonWidth}" Height="{Binding NavButtonHeight}"
                                 Foreground="{DynamicResource TextPrimaryBrush}" FontWeight="Bold" Opacity="0.6" Cursor="Hand"
                                 VerticalContentAlignment="Center" HorizontalContentAlignment="Center">
                         <PathIcon Data="M12,16L19.36,10.27L21,9L12,2L3,9L4.63,10.27M12,18.54L4.62,12.81L3,14.07L12,21.07L21,14.07L19.37,12.8L12,18.54Z" Width="{Binding NavFontSize}" Height="{Binding NavFontSize}" />
                        <RadioButton.Template>
                            <ControlTemplate>
                                <Border Background="{TemplateBinding Background}" CornerRadius="{Binding DataContext.NavCornerRadiusStruct, ElementName=Root}" Padding="{TemplateBinding Padding}">
                                    <ContentPresenter Content="{TemplateBinding Content}" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                </Border>
                            </ControlTemplate>
                        </RadioButton.Template>
                        <RadioButton.Styles>
                            <Style Selector="RadioButton">
                                <Setter Property="Background" Value="Transparent"/>
                                <Setter Property="Transitions">
                                    <Transitions>
                                        <BrushTransition Property="Background" Duration="0:0:0.15"/>
                                        <BrushTransition Property="Foreground" Duration="0:0:0.15"/>
                                    </Transitions>
                                </Setter>
                            </Style>
                            <Style Selector="RadioButton:checked">
                                <Setter Property="Background" Value="{DynamicResource AccentBlueBrush}"/>
                                <Setter Property="Foreground" Value="White"/>
                                <Setter Property="Opacity" Value="1.0"/>
                            </Style>
                        </RadioButton.Styles>
                    </RadioButton>

                    <!-- Locker Tab -->
                    <RadioButton GroupName="NavTabs" IsChecked="{Binding IsLockerTabSelected}"
                                 IsVisible="{Binding IsFolderLockerVisible}"
                                 Padding="0" Width="{Binding NavButtonWidth}" Height="{Binding NavButtonHeight}"
                                 Foreground="{DynamicResource TextPrimaryBrush}" FontWeight="Bold" Opacity="0.6" Cursor="Hand"
                                 VerticalContentAlignment="Center" HorizontalContentAlignment="Center">
                        <PathIcon Data="M12,17C10.89,17 10,16.1 10,15C10,13.89 10.89,13 12,13A2,2 0 0,1 14,15A2,2 0 0,1 12,17M18,20V10H6V20H18M18,8A2,2 0 0,1 20,10V20A2,2 0 0,1 18,22H6C4.89,22 4,21.1 4,20V10C4,8.89 4.89,8 6,8H7V6A5,5 0 0,1 12,1A5,5 0 0,1 17,6V8H18M12,3A3,3 0 0,0 9,6V8H15V6A3,3 0 0,0 12,3Z"
                                  Width="{Binding NavFontSize}" Height="{Binding NavFontSize}" />
                        <RadioButton.Template>
                            <ControlTemplate>
                                <Border Background="{TemplateBinding Background}" CornerRadius="{Binding DataContext.NavCornerRadiusStruct, ElementName=Root}" Padding="{TemplateBinding Padding}">
                                    <ContentPresenter Content="{TemplateBinding Content}" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                </Border>
                            </ControlTemplate>
                        </RadioButton.Template>
                        <RadioButton.Styles>
                            <Style Selector="RadioButton">
                                <Setter Property="Background" Value="Transparent"/>
                                <Setter Property="Transitions">
                                    <Transitions>
                                        <BrushTransition Property="Background" Duration="0:0:0.15"/>
                                        <BrushTransition Property="Foreground" Duration="0:0:0.15"/>
                                    </Transitions>
                                </Setter>
                            </Style>
                            <Style Selector="RadioButton:checked">
                                <Setter Property="Background" Value="{DynamicResource AccentBlueBrush}"/>
                                <Setter Property="Foreground" Value="White"/>
                                <Setter Property="Opacity" Value="1.0"/>
                            </Style>
                        </RadioButton.Styles>
                    </RadioButton>
                </StackPanel>
            </Border>
            
            <!-- MAIN CONTENT AREA -->
            <Grid Grid.Row="1" ClipToBounds="True">
                
                <!-- DASHBOARD TAB CONTENT -->
                <Grid IsVisible="{Binding IsDashboardTabSelected}" Margin="20,0,20,0">
                    <!-- StatsPanel -->
                    <Border x:Name="Part_Stats" 
                            CornerRadius="20" Padding="10"
                            VerticalAlignment="Stretch" HorizontalAlignment="Stretch"
                            Background="Transparent">
                        <Viewbox Stretch="Uniform" StretchDirection="DownOnly" VerticalAlignment="Center">
                            <Grid ColumnDefinitions="*,*" RowDefinitions="*,*" VerticalAlignment="Center">
                                <controls:StatWidget Grid.Row="0" Grid.Column="0" Margin="6" DisplayMode="Bar" Label="{Binding Language[Stats.Editing]}" Value="{Binding StatEditing}" Percentage="{Binding StatEditingPercentage}" 
                                                     Color="{DynamicResource AccentEditingBrush}" ShowIcon="False" AnimationDuration="{Binding StatAnimationDuration}" 
                                                     Command="{Binding OpenEditingListCommand}" WindowCommand="{Binding OpenEditingWindowCommand}"/>
                                <controls:StatWidget Grid.Row="0" Grid.Column="1" Margin="6" DisplayMode="Bar" Label="{Binding Language[Stats.Revision]}" Value="{Binding StatRevision}" Percentage="{Binding StatRevisionPercentage}" 
                                                     Color="{DynamicResource AccentRevisionBrush}" ShowIcon="False" AnimationDuration="{Binding StatAnimationDuration}" 
                                                     Command="{Binding OpenRevisionListCommand}" WindowCommand="{Binding OpenRevisionWindowCommand}"/>
                                <controls:StatWidget Grid.Row="1" Grid.Column="0" Margin="6" DisplayMode="Bar" Label="{Binding Language[Stats.Late]}" Value="{Binding StatLate}" Percentage="{Binding StatLatePercentage}" 
                                                     Color="{DynamicResource AccentLateBrush}" ShowIcon="False" AnimationDuration="{Binding StatAnimationDuration}" 
                                                     Command="{Binding OpenLateListCommand}" WindowCommand="{Binding OpenLateWindowCommand}"/>
                                <controls:StatWidget Grid.Row="1" Grid.Column="1" Margin="6" DisplayMode="Bar" Label="{Binding Language[Stats.Points]}" Value="{Binding StatPoints}" Percentage="{Binding StatPointsPercentage}" 
                                                     Color="{DynamicResource AccentPointsBrush}" ShowIcon="False" AnimationDuration="{Binding StatAnimationDuration}"
                                                     WindowCommand="{Binding OpenLeaderboardWindowCommand}"/>
                            </Grid>
                        </Viewbox>
                    </Border>
                </Grid>
                    
                <!-- BATCH TAB CONTENT (REDESIGNED) -->
                <Grid IsVisible="{Binding IsBatchTabSelected}" RowDefinitions="*, Auto" Margin="20,0,20,0">
                    
                    <!-- DROP ZONE (Visible when no folders) -->
                    <Border Grid.Row="0" x:Name="BatchDropZone"
                            IsVisible="{Binding BatchVM.ShowDropZone}"
                            Background="{DynamicResource CardBackgroundBrush}" 
                            CornerRadius="20" Padding="40"
                            BorderBrush="{DynamicResource CardBorderBrush}" BorderThickness="2"
                            HorizontalAlignment="Stretch" VerticalAlignment="Stretch"
                            MinHeight="200"
                            DragDrop.AllowDrop="True">
                        <StackPanel Spacing="15" HorizontalAlignment="Center" VerticalAlignment="Center">
                            <shapes:Path Data="M19,13H13V19H11V13H5V11H11V5H13V11H19M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2Z" 
                                         Width="64" Height="64" Fill="{DynamicResource TextSecondaryBrush}" Stretch="Uniform" HorizontalAlignment="Center" Opacity="0.5"/>
                            <TextBlock Text="DRAG FOLDERS HERE" FontSize="16" FontWeight="Bold" 
                                       Foreground="{DynamicResource TextSecondaryBrush}" HorizontalAlignment="Center"/>
                            <TextBlock Text="Drop source folders to begin batch processing" FontSize="12" 
                                       Foreground="{DynamicResource TextSecondaryBrush}" HorizontalAlignment="Center" Opacity="0.7"/>
                        </StackPanel>
                    </Border>
                    
                    <!-- EXPLORER VIEW (Visible when folders exist) -->
                    <Grid Grid.Row="0" ColumnDefinitions="*,*" IsVisible="{Binding BatchVM.HasFolders}">
                         
                        <!-- SOURCE PANEL -->
                        <Grid Grid.Column="0" Margin="0,0,5,0">
                            <Border Background="{DynamicResource CardBackgroundBrush}" CornerRadius="20" Padding="10" Margin="0,8,0,0" BorderBrush="{DynamicResource CardBorderBrush}" BorderThickness="1">
                                <TreeView ItemsSource="{Binding BatchVM.SourceFolders}"
                                          SelectionMode="Single"
                                          ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                                          Background="Transparent" BorderThickness="0">
                                      <TreeView.DataTemplates>
                                          <TreeDataTemplate DataType="{x:Type vm:BatchFolderRoot}" ItemsSource="{Binding SourceRoot.Children}">
                                              <StackPanel Orientation="Horizontal" Spacing="4" Margin="0,-2">
                                                   <!-- Icon Removed -->
                                                   <TextBlock Text="{Binding DisplayName}" FontWeight="SemiBold" FontSize="10" Foreground="{DynamicResource TextPrimaryBrush}" VerticalAlignment="Center"/>
                                                   <!-- Icon Removed -->
                                              </StackPanel>
                                          </TreeDataTemplate>
                                      </TreeView.DataTemplates>
                                      <TreeView.Styles>
                                          <Style Selector="TreeViewItem">
                                               <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}"/>
                                               <Setter Property="MinHeight" Value="0"/>
                                               <Setter Property="Padding" Value="0"/>
                                               <Setter Property="Margin" Value="0"/>
                                          </Style>
                                      </TreeView.Styles>
                                </TreeView>
                            </Border>
                            <Border VerticalAlignment="Top" HorizontalAlignment="Left" Margin="20,0,0,0" Background="{DynamicResource CardBackgroundBrush}" Padding="6,0" CornerRadius="4">
                                <TextBlock Text="PILIHAN (TREE)" FontWeight="Bold" FontSize="10" Foreground="{DynamicResource AccentBlueBrush}" VerticalAlignment="Center"/>
                            </Border>
                        </Grid>
                        
                        <!-- OUTPUT PANEL -->
                        <Grid Grid.Column="1" Margin="5,0,0,0">
                            <Border Background="{DynamicResource CardBackgroundBrush}" CornerRadius="20" Padding="10" Margin="0,8,0,0" BorderBrush="{DynamicResource CardBorderBrush}" BorderThickness="1">
                                <TreeView ItemsSource="{Binding BatchVM.SourceFolders}"
                                          SelectionMode="Single"
                                          ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                                          Background="Transparent" BorderThickness="0">
                                      <TreeView.DataTemplates>
                                          <TreeDataTemplate DataType="{x:Type vm:BatchFolderRoot}" ItemsSource="{Binding OutputRoot.Children}">
                                              <StackPanel Orientation="Horizontal" Spacing="4" Margin="0,-2">
                                                   <!-- Icon Removed -->
                                                   <TextBlock Text="{Binding OutputHeader}" FontWeight="SemiBold" FontSize="10" Foreground="{DynamicResource TextPrimaryBrush}" VerticalAlignment="Center"/>
                                                   <TextBlock Text="(pending)" FontSize="10" Foreground="{DynamicResource TextSecondaryBrush}" IsVisible="{Binding OutputRoot, Converter={x:Static ObjectConverters.IsNull}}" VerticalAlignment="Center"/>
                                              </StackPanel>
                                          </TreeDataTemplate>
                                      </TreeView.DataTemplates>
                                      <TreeView.Styles>
                                          <Style Selector="TreeViewItem">
                                               <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}"/>
                                               <Setter Property="MinHeight" Value="18"/>
                                               <Setter Property="Padding" Value="0"/>
                                               <Setter Property="Margin" Value="0"/>
                                          </Style>
                                      </TreeView.Styles>
                                </TreeView>
                            </Border>
                            <Border VerticalAlignment="Top" HorizontalAlignment="Right" Margin="0,0,20,0" Background="{DynamicResource CardBackgroundBrush}" Padding="6,0" CornerRadius="4">
                                <TextBlock Text="OUTPUT LOKAL" FontWeight="Bold" FontSize="10" Foreground="{DynamicResource TextPrimaryBrush}" VerticalAlignment="Center"/>
                            </Border>
                        </Grid>
                    </Grid>
                    
                    <!-- NEW FOOTER LAYOUT (REDESIGNED) -->
                    <Border Grid.Row="1" Margin="0,10,0,0" 
                            Background="{DynamicResource CardBackgroundBrush}" 
                            CornerRadius="12,12,0,0" Padding="15,10"
                            BorderBrush="{DynamicResource CardBorderBrush}" BorderThickness="1,1,1,0"
                            IsVisible="{Binding BatchVM.HasFolders}">
                            <Grid ColumnDefinitions="*, Auto">
                                <!-- Horizontal Scrollable Master Buttons -->
                                <ScrollViewer Grid.Column="0" HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Disabled" Margin="0,0,10,0">
                                    <StackPanel Orientation="Horizontal" Spacing="10">
                                        
                                        <!-- Master ItemsControl -->
                                        <ItemsControl ItemsSource="{Binding BatchVM.MasterScriptOrderList}">
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <StackPanel Orientation="Horizontal" Spacing="8"/>
                                                </ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Button Command="{Binding DataContext.BatchVM.ExecuteSpecificMasterCommand, ElementName=Root}"
                                                            CommandParameter="{Binding}"
                                                            Width="32" Height="32" Padding="0" CornerRadius="8" Cursor="Hand"
                                                            Background="#2A2A2A" BorderThickness="0"
                                                            ToolTip.Tip="{Binding Name}">
                                                        <Button.Styles>
                                                            <Style Selector="Button:pointerover /template/ ContentPresenter#PART_ContentPresenter">
                                                                <Setter Property="Background" Value="{DynamicResource AccentBlueBrush}"/>
                                                            </Style>
                                                        </Button.Styles>
                                                        <Panel>
                                                            <!-- Icon -->
                                                            <PathIcon Data="{Binding IconGeometry}" Width="16" Height="16" Foreground="White"
                                                                      HorizontalAlignment="Center" VerticalAlignment="Center" IsVisible="{Binding IconGeometry, Converter={x:Static ObjectConverters.IsNotNull}}"/>
                                                            <!-- Failover Generic Icon if null -->
                                                            <PathIcon Data="{StaticResource IconScript}" Width="16" Height="16" Foreground="White"
                                                                      HorizontalAlignment="Center" VerticalAlignment="Center" IsVisible="{Binding IconGeometry, Converter={x:Static ObjectConverters.IsNull}}"/>
                                                        </Panel>
                                                    </Button>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </StackPanel>
                                </ScrollViewer>
                                
                                <!-- Utility Buttons (Right) -->
                                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="5" VerticalAlignment="Center">
                                    <!-- Scripts Path Button -->
                                    <Button Command="{Binding BatchVM.BrowseScriptsFolderCommand}" 
                                            Width="32" Height="32" Padding="0"
                                            Background="Transparent" BorderBrush="{DynamicResource CardBorderBrush}" BorderThickness="1"
                                            CornerRadius="4" ToolTip.Tip="Set Scripts Folder">
                                        <shapes:Path Data="M10,4H4C2.89,4 2,4.89 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V8C22,6.89 21.1,6 20,6H12L10,4Z" 
                                                     Width="14" Height="14" Fill="{DynamicResource AccentBlueBrush}" Stretch="Uniform"/>
                                    </Button>
                                    
                                    <!-- Clear Button -->
                                    <Button Command="{Binding BatchVM.ClearCommand}" 
                                            Width="32" Height="32" Padding="0"
                                            Background="Transparent" BorderBrush="{DynamicResource CardBorderBrush}" BorderThickness="1"
                                            CornerRadius="4" ToolTip.Tip="Clear All">
                                        <PathIcon Data="{StaticResource IconTrash}" Width="16" Height="16" Foreground="{DynamicResource AccentRedBrush}"/>
                                    </Button>
                                </StackPanel>
                            </Grid>
                    </Border>
                </Grid>

                <!-- LOCKER TAB CONTENT -->
                <views:FolderLockerView DataContext="{Binding FolderLockerVM}" 
                                        IsVisible="{Binding DataContext.IsLockerTabSelected, ElementName=Root}" 
                                        Margin="20,0,20,0"/>
                                        
                <!-- PIXELCUT TAB CONTENT -->
                <views:CompactPixelcutView DataContext="{Binding PixelcutVM}"
                                           IsVisible="{Binding DataContext.IsPixelcutTabSelected, ElementName=Root}"
                                           Margin="20,0,20,0"/>

                <!-- GDRIVE TAB CONTENT -->
                <views:CompactGdriveView DataContext="{Binding GdriveVM}"
                                         IsVisible="{Binding DataContext.IsGdriveTabSelected, ElementName=Root}"
                                         Margin="20,0,20,0"/>
        </Grid>
    </Grid>

    <!-- GRID SPLITTER (DISABLED) -->
    <GridSplitter Grid.Column="2" Width="0" HorizontalAlignment="Stretch" Background="Transparent" 
                  ResizeDirection="Columns" IsVisible="False"/>

    <!-- LOG PANEL (NOW RIGHT) -->
    <views:LogPanelSidebar Grid.Column="3" Width="279"
                           IsVisible="{Binding IsLogPanelOpen}" 
                           VerticalAlignment="Stretch"/>
</Grid>
</UserControl>
