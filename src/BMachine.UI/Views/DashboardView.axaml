<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:controls="clr-namespace:BMachine.UI.Controls"
             xmlns:views="using:BMachine.UI.Views"
             xmlns:shapes="using:Avalonia.Controls.Shapes"
             mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="800"
             x:Class="BMachine.UI.Views.DashboardView"
             xmlns:vm="using:BMachine.UI.ViewModels"
             xmlns:models="using:BMachine.UI.Models"
             xmlns:converters="using:BMachine.UI.Converters"
             x:Name="Root">

    <UserControl.Resources>
        <converters:BoolToFolderIconConverter x:Key="BoolToFolderIconConverter"/>
    </UserControl.Resources>

    <UserControl.DataTemplates>
        <TreeDataTemplate DataType="{x:Type vm:BatchNodeItem}" ItemsSource="{Binding Children}">
            <StackPanel x:Name="NodePanel" Orientation="Horizontal" Spacing="4" Background="Transparent" Margin="-28,-2,0,-2"
                        PointerPressed="OnNodePointerPressed">
                <!-- Icons Removed per User Request for Compact Look -->
                
                <Button Command="{Binding CopyPathCommand}" 
                        Classes="plainLink"
                        PointerPressed="OnNodePointerPressed"
                        Height="16" MinHeight="0"
                        Background="Transparent" BorderThickness="0" Padding="0" Margin="0" 
                        Cursor="Hand" ToolTip.Tip="Left-Click: Copy Path | Right-Click: Expand">
                    <TextBlock Text="{Binding Name}" FontSize="10" Foreground="{DynamicResource TextPrimaryBrush}" VerticalAlignment="Center" TextTrimming="CharacterEllipsis" MaxWidth="180"/>
                </Button>
            </StackPanel>
        </TreeDataTemplate>
    </UserControl.DataTemplates>
             
    <UserControl.Styles>
        <!-- Custom Style for Plain Link Button (No Hover) -->
        <Style Selector="Button.plainLink">
            <Setter Property="Background" Value="Transparent"/>
        </Style>
        <Style Selector="Button.plainLink:pointerover /template/ ContentPresenter">
            <Setter Property="Background" Value="Transparent"/>
        </Style>
        <Style Selector="Button.plainLink:pressed /template/ ContentPresenter">
            <Setter Property="Background" Value="Transparent"/>
        </Style>

        <!-- Custom Style for Pill Menu Flyout -->
        <Style Selector="FlyoutPresenter">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="CornerRadius" Value="18"/>
            <Setter Property="MinWidth" Value="0"/>
            <Setter Property="Margin" Value="0,4,0,0"/>
        </Style>

        <!-- Master Browser TreeView Styles (PlainTree) -->
        <Style Selector="TreeView.PlainTree TreeViewItem">
            <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}"/>
            <Setter Property="MinHeight" Value="22"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="Margin" Value="0"/>
        </Style>
        <Style Selector="TreeView.PlainTree TreeViewItem /template/ ToggleButton#PART_ExpandCollapseChevron">
            <Setter Property="Width" Value="12"/> 
            <Setter Property="IsVisible" Value="True"/>
        </Style>
    </UserControl.Styles>

    
    <Grid ColumnDefinitions="Auto, *, 0, Auto">
        <!-- COMPACT SIDEBAR (LEFT) -->
        <Border Grid.Column="0" 
                Background="{DynamicResource BackgroundBrush}"
                BorderThickness="0,0,1,0"
                BorderBrush="{DynamicResource CardBorderBrush}"
                Width="50">
            <Border.Effect>
                <DropShadowEffect BlurRadius="8" OffsetX="2" OffsetY="0" Color="#20000000" Opacity="1"/>
            </Border.Effect>
            <Grid RowDefinitions="Auto, *, Auto">
                <!-- Profile Picture (Top) -->
                <Border Grid.Row="0" Width="25" Height="25" CornerRadius="6" 
                        Background="{DynamicResource CardBackgroundBrush}" 
                        ClipToBounds="True" Margin="10,16,10,16"
                        BorderBrush="{DynamicResource CardBorderBrush}" BorderThickness="1">
                    <Panel>
                        <shapes:Path Data="{StaticResource IconUser}" Width="16" Height="16" 
                                   Fill="{DynamicResource TextSecondaryBrush}" Stretch="Uniform" 
                                   HorizontalAlignment="Center" VerticalAlignment="Center"
                                   IsVisible="{Binding UserAvatar, Converter={x:Static ObjectConverters.IsNull}}"/>
                        <Image Source="{Binding UserAvatar}" Stretch="UniformToFill"
                               IsVisible="{Binding UserAvatar, Converter={x:Static ObjectConverters.IsNotNull}}"/>
                    </Panel>
                </Border>
                
                <!-- Middle Spacer -->
                <Border Grid.Row="1"/>
                
                <!-- Bottom Buttons -->
                <StackPanel Grid.Row="2" Spacing="12" HorizontalAlignment="Center" Margin="0,0,0,16">
                    
                    <!-- EXPANDABLE TOOLS (Visible when Expanded) -->
                    <StackPanel Spacing="12" IsVisible="{Binding IsToolsExpanded}">
                        <!-- GDrive Pop-out -->
                        <Button Click="OnGdriveClick" 
                                Width="36" Height="36" Padding="0"
                                Background="Transparent" BorderThickness="0"
                                CornerRadius="8" Cursor="Hand"
                                ToolTip.Tip="GDrive Window">
                             <Button.Styles>
                                <Style Selector="Button:pointerover /template/ ContentPresenter#PART_ContentPresenter">
                                    <Setter Property="Background" Value="{DynamicResource CardBackgroundBrush}"/>
                                </Style>
                            </Button.Styles>
                            <shapes:Path Data="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z" 
                                         Width="16" Height="16" Stretch="Uniform" Fill="{DynamicResource TextPrimaryBrush}"/>
                        </Button>

                        <!-- Pixelcut Pop-out -->
                        <Button Click="OnPixelcutClick" 
                                Width="36" Height="36" Padding="0"
                                Background="Transparent" BorderThickness="0"
                                CornerRadius="8" Cursor="Hand"
                                ToolTip.Tip="Pixelcut Window">
                             <Button.Styles>
                                <Style Selector="Button:pointerover /template/ ContentPresenter#PART_ContentPresenter">
                                    <Setter Property="Background" Value="{DynamicResource CardBackgroundBrush}"/>
                                </Style>
                            </Button.Styles>
                            <shapes:Path Data="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" 
                                         Width="16" Height="16" Stretch="Uniform" Fill="{DynamicResource TextPrimaryBrush}"/>
                        </Button>
                    </StackPanel>

                    <!-- Chevron Toggle -->
                    <Button Command="{Binding ToggleToolsExpandedCommand}" 
                            Width="36" Height="36" Padding="0"
                            Background="Transparent" BorderThickness="0"
                            CornerRadius="8" Cursor="Hand"
                            ToolTip.Tip="Tools">
                         <Button.Styles>
                            <Style Selector="Button:pointerover /template/ ContentPresenter#PART_ContentPresenter">
                                <Setter Property="Background" Value="{DynamicResource CardBackgroundBrush}"/>
                            </Style>
                        </Button.Styles>
                        <Panel>
                             <!-- Chevron Up (Show) -->
                             <shapes:Path Data="M7.41,15.41L12,10.83L16.59,15.41L18,14L12,8L6,14L7.41,15.41Z" 
                                          Width="16" Height="16" Stretch="Uniform" Fill="{DynamicResource TextPrimaryBrush}"
                                          IsVisible="{Binding !IsToolsExpanded}"/>
                             <!-- Chevron Down (Hide) -->
                             <shapes:Path Data="M7.41,8.59L12,13.17L16.59,8.59L18,10L12,16L6,10L7.41,8.59Z" 
                                          Width="16" Height="16" Stretch="Uniform" Fill="{DynamicResource TextPrimaryBrush}"
                                          IsVisible="{Binding IsToolsExpanded}"/>
                        </Panel>
                    </Button>
                    
                    <!-- Terminal/Log Button -->
                    <ToggleButton Command="{Binding ToggleLogPanelCommand}" 
                                  IsChecked="{Binding IsLogPanelOpen, Mode=OneWay}"
                                  Width="36" Height="36" Padding="0"
                                  Background="Transparent" BorderThickness="0"
                                  CornerRadius="8" Cursor="Hand"
                                  ToolTip.Tip="Terminal">
                        <ToggleButton.Styles>
                            <Style Selector="ToggleButton:pointerover /template/ ContentPresenter#PART_ContentPresenter">
                                <Setter Property="Background" Value="{DynamicResource CardBackgroundBrush}"/>
                            </Style>
                        </ToggleButton.Styles>
                        <shapes:Path Data="M19,3H14.82C14.4,1.84 13.3,1 12,1C10.7,1 9.6,1.84 9.18,3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3M12,3A1,1 0 0,1 13,4A1,1 0 0,1 12,5A1,1 0 0,1 11,4A1,1 0 0,1 12,3M7,7H17V9H7V7M7,11H17V13H7V11M7,15H17V17H7V15Z" 
                                     Width="16" Height="16" Stretch="Uniform" Fill="{DynamicResource TextPrimaryBrush}" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                    </ToggleButton>
                    
                    <!-- Settings Button -->
                    <Button Click="OnSettingsClick" 
                            Width="36" Height="36" Padding="0" 
                            Background="Transparent" BorderThickness="0" 
                            CornerRadius="8" Cursor="Hand" 
                            ToolTip.Tip="Settings">
                        <Button.Styles>
                            <Style Selector="Button:pointerover /template/ ContentPresenter#PART_ContentPresenter">
                                <Setter Property="Background" Value="{DynamicResource CardBackgroundBrush}"/>
                            </Style>
                        </Button.Styles>
                        <shapes:Path Data="{StaticResource IconSettings}" Width="16" Height="16" Stretch="Uniform" Fill="{DynamicResource TextPrimaryBrush}"/>
                    </Button>
                    
                    <!-- Logout Button -->
                    <Button Command="{Binding OpenLogoutDialogCommand}" 
                            Width="36" Height="36" Padding="0" 
                            Background="Transparent" BorderThickness="0" 
                            CornerRadius="8" Cursor="Hand" 
                            ToolTip.Tip="Log Out">
                        <Button.Styles>
                            <Style Selector="Button:pointerover /template/ ContentPresenter#PART_ContentPresenter">
                                <Setter Property="Background" Value="{DynamicResource CardBackgroundBrush}"/>
                            </Style>
                        </Button.Styles>
                        <shapes:Path Data="M16.56,5.44L15.11,6.89C16.84,7.94 18,9.83 18,12A6,6 0 0,1 12,18A6,6 0 0,1 6,12C6,9.83 7.16,7.94 8.88,6.88L7.44,5.44C5.36,6.88 4,9.28 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12C20,9.28 18.64,6.88 16.56,5.44M13,3H11V13H13" 
                                     Width="16" Height="16" Stretch="Uniform" Fill="{DynamicResource TextPrimaryBrush}"/>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>
        
        <!-- Vertical Separator (like terminal) -->
        <Border Grid.Column="0" Width="1" Background="#33FFFFFF" HorizontalAlignment="Right" Margin="0" ZIndex="10"/>
        
        <!-- MAIN DASHBOARD AREA (Content) -->
        <Grid Grid.Column="1" RowDefinitions="Auto, *" MinWidth="479">
            <!-- NAVIGATION BAR (Horizontal, at top) -->
            <Border Grid.Row="0" HorizontalAlignment="Center" Background="{DynamicResource CardBackgroundBrush}" 
                    CornerRadius="12" Padding="4" Margin="12,12,12,6" BorderBrush="{DynamicResource CardBorderBrush}" BorderThickness="1">
                <StackPanel Orientation="Horizontal" Spacing="0">
                    <!-- GDrive Tab -->
                    <RadioButton GroupName="NavTabs" IsChecked="{Binding IsGdriveTabSelected}"
                                 IsVisible="{Binding IsGdriveVisible}"
                                 Padding="0" Width="{Binding NavButtonWidth}" Height="{Binding NavButtonHeight}"
                                 Foreground="{DynamicResource TextPrimaryBrush}" FontWeight="Bold" Opacity="0.6" Cursor="Hand"
                                 VerticalContentAlignment="Center" HorizontalContentAlignment="Center">
                        <PathIcon Data="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z" Width="{Binding NavFontSize}" Height="{Binding NavFontSize}" />
                        <RadioButton.Template>
                            <ControlTemplate>
                                <Border Background="{TemplateBinding Background}" CornerRadius="{Binding DataContext.NavCornerRadiusStruct, ElementName=Root}" Padding="{TemplateBinding Padding}">
                                    <ContentPresenter Content="{TemplateBinding Content}" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                </Border>
                            </ControlTemplate>
                        </RadioButton.Template>
                        <RadioButton.Styles>
                            <Style Selector="RadioButton">
                                <Setter Property="Background" Value="Transparent"/>
                                <Setter Property="Transitions">
                                    <Transitions>
                                        <BrushTransition Property="Background" Duration="0:0:0.15"/>
                                        <BrushTransition Property="Foreground" Duration="0:0:0.15"/>
                                    </Transitions>
                                </Setter>
                            </Style>
                            <Style Selector="RadioButton:checked">
                                <Setter Property="Background" Value="{DynamicResource AccentBlueBrush}"/>
                                <Setter Property="Foreground" Value="White"/>
                                <Setter Property="Opacity" Value="1.0"/>
                            </Style>
                        </RadioButton.Styles>
                    </RadioButton>

                    <!-- Pixelcut Tab -->
                    <RadioButton GroupName="NavTabs" IsChecked="{Binding IsPixelcutTabSelected}"
                                 IsVisible="{Binding IsPixelcutVisible}"
                                 Padding="0" Width="{Binding NavButtonWidth}" Height="{Binding NavButtonHeight}"
                                 Foreground="{DynamicResource TextPrimaryBrush}" FontWeight="Bold" Opacity="0.6" Cursor="Hand"
                                 VerticalContentAlignment="Center" HorizontalContentAlignment="Center">
                        <PathIcon Data="M20,6 L18.59,4.59 L14.73,8.45 L13.32,7.04 L17.18,3.18 L15.76,1.76 L13.64,3.88 C13.06,3.33 12.29,3 11.5,3 C9.57,3 8,4.57 8,6.5 C8,7.29 8.27,8.03 8.74,8.63 L6,11.37 C5.53,10.9 5.25,10.27 5.25,9.58 C5.25,8.13 6.42,6.96 7.88,6.96 C8.4,6.96 8.82,6.54 8.82,6.02 C8.82,5.5 8.4,5.08 7.88,5.08 C5.39,5.08 3.37,7.1 3.37,9.58 C3.37,10.79 3.86,11.9 4.66,12.71 L2.25,15.12 L3.66,16.54 L7.52,12.68 L8.93,14.09 L5.07,17.95 L6.49,19.36 L9.29,16.56 C10.1,17.37 11.21,17.86 12.42,17.86 C14.91,17.86 16.92,15.84 16.92,13.36 C16.92,12.83 16.5,12.41 15.98,12.41 C15.46,12.41 15.04,12.83 15.04,13.36 C15.04,14.81 13.86,15.98 12.42,15.98 C11.72,15.98 11.09,15.7 10.63,15.22 L13.37,12.48 C13.97,12.95 14.71,13.23 15.5,13.23 C17.43,13.23 19,11.66 19,9.73 C19,8.94 18.73,8.2 18.26,7.6 L20.38,5.48 L20.4,5.5 L20,6 M11.5,4.88 C12.4,4.88 13.12,5.6 13.12,6.5 C13.12,7.4 12.4,8.12 11.5,8.12 C10.6,8.12 9.88,7.4 9.88,6.5 C9.88,5.6 10.6,4.88 11.5,4.88 M15.5,11.35 C14.6,11.35 13.88,10.63 13.88,9.73 C13.88,8.83 14.6,8.11 15.5,8.11 C16.4,8.11 17.12,8.83 17.12,9.73 C17.12,10.63 16.4,11.35 15.5,11.35" Width="{Binding NavFontSize}" Height="{Binding NavFontSize}" />
                        <RadioButton.Template>
                            <ControlTemplate>
                                <Border Background="{TemplateBinding Background}" CornerRadius="{Binding DataContext.NavCornerRadiusStruct, ElementName=Root}" Padding="{TemplateBinding Padding}">
                                    <ContentPresenter Content="{TemplateBinding Content}" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                </Border>
                            </ControlTemplate>
                        </RadioButton.Template>
                        <RadioButton.Styles>
                            <Style Selector="RadioButton">
                                <Setter Property="Background" Value="Transparent"/>
                                <Setter Property="Transitions">
                                    <Transitions>
                                        <BrushTransition Property="Background" Duration="0:0:0.15"/>
                                        <BrushTransition Property="Foreground" Duration="0:0:0.15"/>
                                    </Transitions>
                                </Setter>
                            </Style>
                            <Style Selector="RadioButton:checked">
                                <Setter Property="Background" Value="{DynamicResource AccentBlueBrush}"/>
                                <Setter Property="Foreground" Value="White"/>
                                <Setter Property="Opacity" Value="1.0"/>
                            </Style>
                        </RadioButton.Styles>
                    </RadioButton>

                    <!-- Link to Explorer Tab (Moved) -->
                    <RadioButton GroupName="NavTabs" IsChecked="{Binding IsExplorerTabSelected}"
                                 IsVisible="{Binding IsOutputExplorerVisible}"
                                 Padding="0" Width="{Binding NavButtonWidth}" Height="{Binding NavButtonHeight}"
                                 Foreground="{DynamicResource TextPrimaryBrush}" FontWeight="Bold" Opacity="0.6" Cursor="Hand"
                                 VerticalContentAlignment="Center" HorizontalContentAlignment="Center"
                                 ToolTip.Tip="Output Explorer">
                        <PathIcon Data="M19,20H5V4H7V7H17V4H19M12,2A1,1 0 0,1 13,3A1,1 0 0,1 12,4A1,1 0 0,1 11,3A1,1 0 0,1 12,2M19,2H14.82C14.4,0.84 13.3,0 12,0C10.7,0 9.6,0.84 9.18,2H5A2,2 0 0,0 3,4V20A2,2 0 0,0 5,22H19A2,2 0 0,0 21,20V4A2,2 0 0,0 19,2M12,2A1,1 0 0,1 13,3A1,1 0 0,1 12,4A1,1 0 0,1 11,3A1,1 0 0,1 12,2Z" Width="{Binding NavFontSize}" Height="{Binding NavFontSize}" />
                        <RadioButton.Template>
                            <ControlTemplate>
                                <Border Background="{TemplateBinding Background}" CornerRadius="{Binding DataContext.NavCornerRadiusStruct, ElementName=Root}" Padding="{TemplateBinding Padding}">
                                    <ContentPresenter Content="{TemplateBinding Content}" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                </Border>
                            </ControlTemplate>
                        </RadioButton.Template>
                        <RadioButton.Styles>
                            <Style Selector="RadioButton">
                                <Setter Property="Background" Value="Transparent"/>
                                <Setter Property="Transitions">
                                    <Transitions>
                                        <BrushTransition Property="Background" Duration="0:0:0.15"/>
                                        <BrushTransition Property="Foreground" Duration="0:0:0.15"/>
                                    </Transitions>
                                </Setter>
                            </Style>
                            <Style Selector="RadioButton:checked">
                                <Setter Property="Background" Value="{DynamicResource AccentBlueBrush}"/>
                                <Setter Property="Foreground" Value="White"/>
                                <Setter Property="Opacity" Value="1.0"/>
                            </Style>
                        </RadioButton.Styles>
                    </RadioButton>

                    <!-- Dashboard Tab -->
                    <RadioButton GroupName="NavTabs" IsChecked="{Binding IsDashboardTabSelected, Mode=TwoWay}"
                                 Padding="0" Width="{Binding NavButtonWidth}" Height="{Binding NavButtonHeight}"
                                 Foreground="{DynamicResource TextPrimaryBrush}" FontWeight="Bold" Opacity="0.6" Cursor="Hand"
                                 VerticalContentAlignment="Center" HorizontalContentAlignment="Center">
                        <PathIcon Data="M10,20V14H14V20H19V12H22L12,3L2,12H5V20H10Z" Width="{Binding NavFontSize}" Height="{Binding NavFontSize}" />
                        <RadioButton.Template>
                            <ControlTemplate>
                                <Border Background="{TemplateBinding Background}" CornerRadius="{Binding DataContext.NavCornerRadiusStruct, ElementName=Root}" Padding="{TemplateBinding Padding}">
                                    <ContentPresenter Content="{TemplateBinding Content}" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                </Border>
                            </ControlTemplate>
                        </RadioButton.Template>
                        <RadioButton.Styles>
                            <Style Selector="RadioButton">
                                <Setter Property="Background" Value="Transparent"/>
                                <Setter Property="Transitions">
                                    <Transitions>
                                        <BrushTransition Property="Background" Duration="0:0:0.15"/>
                                        <BrushTransition Property="Foreground" Duration="0:0:0.15"/>
                                    </Transitions>
                                </Setter>
                            </Style>
                            <Style Selector="RadioButton:checked">
                                <Setter Property="Background" Value="{DynamicResource AccentBlueBrush}"/>
                                <Setter Property="Foreground" Value="White"/>
                                <Setter Property="Opacity" Value="1.0"/>
                            </Style>
                        </RadioButton.Styles>
                    </RadioButton>

                    <!-- Batch Tab -->
                    <RadioButton GroupName="NavTabs" IsChecked="{Binding IsBatchTabSelected}"
                                 IsVisible="{Binding IsBatchVisible}"
                                 Padding="0" Width="{Binding NavButtonWidth}" Height="{Binding NavButtonHeight}"
                                 Foreground="{DynamicResource TextPrimaryBrush}" FontWeight="Bold" Opacity="0.6" Cursor="Hand"
                                 VerticalContentAlignment="Center" HorizontalContentAlignment="Center">
                         <PathIcon Data="M12,16L19.36,10.27L21,9L12,2L3,9L4.63,10.27M12,18.54L4.62,12.81L3,14.07L12,21.07L21,14.07L19.37,12.8L12,18.54Z" Width="{Binding NavFontSize}" Height="{Binding NavFontSize}" />
                        <RadioButton.Template>
                            <ControlTemplate>
                                <Border Background="{TemplateBinding Background}" CornerRadius="{Binding DataContext.NavCornerRadiusStruct, ElementName=Root}" Padding="{TemplateBinding Padding}">
                                    <ContentPresenter Content="{TemplateBinding Content}" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                </Border>
                            </ControlTemplate>
                        </RadioButton.Template>
                        <RadioButton.Styles>
                            <Style Selector="RadioButton">
                                <Setter Property="Background" Value="Transparent"/>
                                <Setter Property="Transitions">
                                    <Transitions>
                                        <BrushTransition Property="Background" Duration="0:0:0.15"/>
                                        <BrushTransition Property="Foreground" Duration="0:0:0.15"/>
                                    </Transitions>
                                </Setter>
                            </Style>
                            <Style Selector="RadioButton:checked">
                                <Setter Property="Background" Value="{DynamicResource AccentBlueBrush}"/>
                                <Setter Property="Foreground" Value="White"/>
                                <Setter Property="Opacity" Value="1.0"/>
                            </Style>
                        </RadioButton.Styles>
                    </RadioButton>

                    <!-- Locker Tab -->
                    <RadioButton GroupName="NavTabs" IsChecked="{Binding IsLockerTabSelected}"
                                 IsVisible="{Binding IsFolderLockerVisible}"
                                 Padding="0" Width="{Binding NavButtonWidth}" Height="{Binding NavButtonHeight}"
                                 Foreground="{DynamicResource TextPrimaryBrush}" FontWeight="Bold" Opacity="0.6" Cursor="Hand"
                                 VerticalContentAlignment="Center" HorizontalContentAlignment="Center">
                        <PathIcon Data="M12,17C10.89,17 10,16.1 10,15C10,13.89 10.89,13 12,13A2,2 0 0,1 14,15A2,2 0 0,1 12,17M18,20V10H6V20H18M18,8A2,2 0 0,1 20,10V20A2,2 0 0,1 18,22H6C4.89,22 4,21.1 4,20V10C4,8.89 4.89,8 6,8H7V6A5,5 0 0,1 12,1A5,5 0 0,1 17,6V8H18M12,3A3,3 0 0,0 9,6V8H15V6A3,3 0 0,0 12,3Z"
                                  Width="{Binding NavFontSize}" Height="{Binding NavFontSize}" />
                        <RadioButton.Template>
                            <ControlTemplate>
                                <Border Background="{TemplateBinding Background}" CornerRadius="{Binding DataContext.NavCornerRadiusStruct, ElementName=Root}" Padding="{TemplateBinding Padding}">
                                    <ContentPresenter Content="{TemplateBinding Content}" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                </Border>
                            </ControlTemplate>
                        </RadioButton.Template>
                        <RadioButton.Styles>
                            <Style Selector="RadioButton">
                                <Setter Property="Background" Value="Transparent"/>
                                <Setter Property="Transitions">
                                    <Transitions>
                                        <BrushTransition Property="Background" Duration="0:0:0.15"/>
                                        <BrushTransition Property="Foreground" Duration="0:0:0.15"/>
                                    </Transitions>
                                </Setter>
                            </Style>
                            <Style Selector="RadioButton:checked">
                                <Setter Property="Background" Value="{DynamicResource AccentBlueBrush}"/>
                                <Setter Property="Foreground" Value="White"/>
                                <Setter Property="Opacity" Value="1.0"/>
                            </Style>
                        </RadioButton.Styles>
                    </RadioButton>


                </StackPanel>
            </Border>
            
            <!-- MAIN CONTENT AREA -->
            <Grid Grid.Row="1" ClipToBounds="True">
                
                <!-- DASHBOARD TAB CONTENT -->
                <Grid IsVisible="{Binding IsDashboardTabSelected}" Width="490" HorizontalAlignment="Center">
                    <!-- StatsPanel -->
                    <Border x:Name="Part_Stats" 
                            CornerRadius="20" Padding="10"
                            VerticalAlignment="Stretch" HorizontalAlignment="Stretch"
                            Background="Transparent">
                        <Viewbox Stretch="Uniform" StretchDirection="DownOnly" VerticalAlignment="Center">
                            <Grid ColumnDefinitions="*,*" RowDefinitions="*,*" VerticalAlignment="Center">
                                <controls:StatWidget Grid.Row="0" Grid.Column="0" Margin="6" Width="220" Height="120" DisplayMode="Bar" Label="{Binding Language[Stats.Editing]}" Value="{Binding StatEditing}" Percentage="{Binding StatEditingPercentage}" 
                                                     Color="{DynamicResource AccentEditingBrush}" ShowIcon="False" AnimationDuration="{Binding StatAnimationDuration}" 
                                                     Command="{Binding OpenEditingListCommand}" WindowCommand="{Binding OpenEditingWindowCommand}"/>
                                <controls:StatWidget Grid.Row="0" Grid.Column="1" Margin="6" Width="220" Height="120" DisplayMode="Bar" Label="{Binding Language[Stats.Revision]}" Value="{Binding StatRevision}" Percentage="{Binding StatRevisionPercentage}" 
                                                     Color="{DynamicResource AccentRevisionBrush}" ShowIcon="False" AnimationDuration="{Binding StatAnimationDuration}" 
                                                     Command="{Binding OpenRevisionListCommand}" WindowCommand="{Binding OpenRevisionWindowCommand}"/>
                                <controls:StatWidget Grid.Row="1" Grid.Column="0" Margin="6" Width="220" Height="120" DisplayMode="Bar" Label="{Binding Language[Stats.Late]}" Value="{Binding StatLate}" Percentage="{Binding StatLatePercentage}" 
                                                     Color="{DynamicResource AccentLateBrush}" ShowIcon="False" AnimationDuration="{Binding StatAnimationDuration}" 
                                                     Command="{Binding OpenLateListCommand}" WindowCommand="{Binding OpenLateWindowCommand}"/>
                                <controls:StatWidget Grid.Row="1" Grid.Column="1" Margin="6" Width="220" Height="120" DisplayMode="Bar" Label="{Binding Language[Stats.Points]}" Value="{Binding StatPoints}" Percentage="{Binding StatPointsPercentage}" 
                                                     Color="{DynamicResource AccentPointsBrush}" ShowIcon="False" AnimationDuration="{Binding StatAnimationDuration}"
                                                     Command="{Binding OpenLeaderboardWindowCommand}" WindowCommand="{Binding OpenSpreadsheetWindowCommand}"/>
                            </Grid>
                        </Viewbox>
                    </Border>
                </Grid>
                    
                <!-- OUTPUT EXPLORER TAB CONTENT -->
                <Grid IsVisible="{Binding IsExplorerTabSelected}" Margin="20,0,20,0">
                     <views:OutputExplorerView DataContext="{Binding OutputExplorerVM}"/>
                </Grid>

                <!-- BATCH TAB CONTENT (REDESIGNED) -->
                <Grid IsVisible="{Binding IsBatchTabSelected}" RowDefinitions="*, Auto" Margin="20,0,20,0">
                    
                    <!-- DROP ZONE (Visible when no folders) -->
                    <Border Grid.Row="0" x:Name="BatchDropZone"
                            IsVisible="{Binding BatchVM.ShowDropZone}"
                            Background="{DynamicResource CardBackgroundBrush}" 
                            CornerRadius="20" Padding="40"
                            BorderBrush="{DynamicResource CardBorderBrush}" BorderThickness="2"
                            HorizontalAlignment="Stretch" VerticalAlignment="Stretch"
                            MinHeight="200"
                            DragDrop.AllowDrop="True">
                        <StackPanel Spacing="15" HorizontalAlignment="Center" VerticalAlignment="Center">
                            <shapes:Path Data="M19,13H13V19H11V13H5V11H11V5H13V11H19M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2Z" 
                                         Width="64" Height="64" Fill="{DynamicResource TextSecondaryBrush}" Stretch="Uniform" HorizontalAlignment="Center" Opacity="0.5"/>
                            <TextBlock Text="DRAG FOLDERS HERE" FontSize="16" FontWeight="Bold" 
                                       Foreground="{DynamicResource TextSecondaryBrush}" HorizontalAlignment="Center"/>
                            <TextBlock Text="Drop source folders to begin batch processing" FontSize="12" 
                                       Foreground="{DynamicResource TextSecondaryBrush}" HorizontalAlignment="Center" Opacity="0.7"/>
                        </StackPanel>
                    </Border>
                    
                    <!-- EXPLORER VIEW (Visible when folders exist) -->
                    <Grid Grid.Row="0" ColumnDefinitions="*,*" IsVisible="{Binding BatchVM.HasFolders}">
                         
                        <!-- SOURCE PANEL -->
                        <Grid Grid.Column="0" Margin="0,0,5,0">
                            <Border Background="{DynamicResource CardBackgroundBrush}" CornerRadius="20" Padding="10" Margin="0,8,0,14" BorderBrush="{DynamicResource CardBorderBrush}" BorderThickness="1">
                                <Grid>
                                    <TreeView ItemsSource="{Binding BatchVM.SourceFolders}"
                                              SelectedItem="{Binding BatchVM.SelectedBatchItem, Mode=TwoWay}"
                                              IsVisible="{Binding !BatchVM.IsMasterBrowserOpenLeft}"
                                              SelectionMode="Single"
                                              ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                                              Background="Transparent" BorderThickness="0">
                                          <TreeView.DataTemplates>
                                              <!-- ROOT LEVEL TEMPLATE -->
                                              <TreeDataTemplate DataType="{x:Type vm:BatchFolderRoot}" ItemsSource="{Binding SourceRoot.Children}">
                                                  <StackPanel Orientation="Horizontal" Spacing="2">
                                                       <!-- MENU BUTTON (Replaces Expander) -->
                                                       <Button Width="20" Height="20" MinHeight="0" Padding="0" Background="Transparent" BorderThickness="0" Cursor="Hand" VerticalAlignment="Center" Margin="0,0,4,0">
                                                           <PathIcon Data="M12,16A2,2 0 0,1 14,18A2,2 0 0,1 12,20A2,2 0 0,1 10,18A2,2 0 0,1 12,16M12,10A2,2 0 0,1 14,12A2,2 0 0,1 12,14A2,2 0 0,1 10,12A2,2 0 0,1 12,10M12,4A2,2 0 0,1 14,6A2,2 0 0,1 12,8A2,2 0 0,1 10,6A2,2 0 0,1 12,4Z" Width="10" Height="10" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                                           <Button.Flyout>
                                                               <Flyout Placement="BottomEdgeAlignedLeft" ShowMode="TransientWithDismissOnPointerMoveAway">
                                                                   <Border Background="{DynamicResource CardBackgroundBrush}" Padding="8" CornerRadius="6" BorderBrush="{DynamicResource CardBorderBrush}" BorderThickness="1">
                                                                       <StackPanel Spacing="8">
                                                                           <TextBlock Text="Folder Options" FontWeight="Bold" FontSize="10" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                                                           <!-- Create Subfolder (Horizontal) -->
                                                                           <StackPanel Orientation="Horizontal" Spacing="4">
                                                                               <TextBox Text="{Binding NewSubFolderName, Mode=TwoWay}" Watermark="New Subfolder..." Width="140" FontSize="11" CornerRadius="4" Padding="6,4">
                                                                                   <TextBox.KeyBindings>
                                                                                       <KeyBinding Gesture="Enter" Command="{Binding CreateSubFolderCommand}"/>
                                                                                   </TextBox.KeyBindings>
                                                                               </TextBox>
                                                                               <Button Command="{Binding CreateSubFolderCommand}" Content="Add" HorizontalContentAlignment="Center" FontSize="11" Padding="8,4" Background="{DynamicResource AccentBlueBrush}" Foreground="White" CornerRadius="4"/>
                                                                           </StackPanel>
                                                                           <Separator Height="1" Background="{DynamicResource CardBorderBrush}"/>
                                                                           <!-- Delete -->
                                                                           <Button Content="Delete Folder" Command="{Binding DeleteCommand}" HorizontalAlignment="Stretch" HorizontalContentAlignment="Center" FontSize="11" Foreground="Red" Background="#1AFF0000" BorderBrush="Red" BorderThickness="1" CornerRadius="4"/>
                                                                       </StackPanel>
                                                                   </Border>
                                                               </Flyout>
                                                           </Button.Flyout>
                                                       </Button>
                                                       
                                                       <TextBlock Text="{Binding DisplayName}" FontWeight="SemiBold" FontSize="11" Foreground="{DynamicResource TextPrimaryBrush}" VerticalAlignment="Center" PointerPressed="OnNodePointerPressed" Cursor="Hand"/>
                                                  </StackPanel>
                                              </TreeDataTemplate>
    
                                              <!-- CHILD LEVEL TEMPLATE -->
                                              <TreeDataTemplate DataType="{x:Type vm:BatchNodeItem}" ItemsSource="{Binding Children}">
                                                  <StackPanel Orientation="Horizontal" Spacing="2">
                                                       <!-- INLINE ACTION BAR & TOGGLE -->
                                                       <Panel VerticalAlignment="Center" Margin="0,0,4,0">
                                                           <!-- 1. TOGGLE BUTTON (Visible when Action Bar CLOSED and Input CLOSED) -->
                                                           <Button Command="{Binding ToggleActionBarCommand}"
                                                                   IsVisible="{Binding !IsActionBarOpen}"
                                                                   Width="20" Height="20" MinHeight="0" Padding="0" 
                                                                   Background="Transparent" BorderThickness="0" 
                                                                   Cursor="Hand">
                                                               <Button.IsVisible>
                                                                   <MultiBinding Converter="{x:Static BoolConverters.And}">
                                                                       <Binding Path="!IsActionBarOpen"/>
                                                                       <Binding Path="!IsNewFolderInputVisible"/>
                                                                   </MultiBinding>
                                                               </Button.IsVisible>
                                                               <PathIcon Data="M12,16A2,2 0 0,1 14,18A2,2 0 0,1 12,20A2,2 0 0,1 10,18A2,2 0 0,1 12,16M12,10A2,2 0 0,1 14,12A2,2 0 0,1 12,14A2,2 0 0,1 10,12A2,2 0 0,1 12,10M12,4A2,2 0 0,1 14,6A2,2 0 0,1 12,8A2,2 0 0,1 10,6A2,2 0 0,1 12,4Z" 
                                                                         Width="10" Height="10" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                                           </Button>
    
                                                           <!-- 2. ACTION BAR (Visible when OPEN) -->
                                                           <StackPanel Orientation="Horizontal" Spacing="6" IsVisible="{Binding IsActionBarOpen}">
                                                               <StackPanel.Styles>
                                                                   <Style Selector="Button.actionBtn:pointerover /template/ ContentPresenter#PART_ContentPresenter">
                                                                       <Setter Property="Background" Value="{Binding $parent[Button].Background}"/>
                                                                   </Style>
                                                               </StackPanel.Styles>
    
                                                               <!-- CLOSE (X) -->
                                                               <Button Command="{Binding CancelActionCommand}"
                                                                       Classes="actionBtn"
                                                                       Width="20" Height="20" MinHeight="0" Padding="0"
                                                                       Background="#303030" CornerRadius="0" BorderThickness="0"
                                                                       Cursor="Hand" ToolTip.Tip="Cancel">
                                                                   <PathIcon Data="{StaticResource IconX}" Width="10" Height="10" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                                               </Button>
                                                               
                                                               <!-- NEW FOLDER (Only for Directories) -->
                                                               <Button Command="{Binding ShowNewFolderInputCommand}"
                                                                       Classes="actionBtn"
                                                                       IsVisible="{Binding IsDirectory}"
                                                                       Width="20" Height="20" MinHeight="0" Padding="0"
                                                                       Background="#303030" CornerRadius="0" BorderThickness="0"
                                                                       Cursor="Hand" ToolTip.Tip="New Subfolder">
                                                                   <Grid>
                                                                       <PathIcon Data="{StaticResource IconFolder}" Width="10" Height="10" Foreground="{DynamicResource TextPrimaryBrush}"/>
                                                                       <PathIcon Data="{StaticResource IconPlus}" Width="6" Height="6" Foreground="{DynamicResource AccentBlueBrush}" VerticalAlignment="Center" HorizontalAlignment="Center" Margin="0,2,0,0"/>
                                                                   </Grid>
                                                               </Button>
                                                               
                                                               <!-- DELETE -->
                                                               <Button Command="{Binding DeleteCommand}"
                                                                       Classes="actionBtn"
                                                                       Width="20" Height="20" MinHeight="0" Padding="0"
                                                                       Background="#33FF0000" CornerRadius="0" BorderThickness="0"
                                                                       Cursor="Hand" ToolTip.Tip="Delete Item">
                                                                   <PathIcon Data="{StaticResource IconTrash}" Width="12" Height="12" Foreground="#FF5555"/>
                                                               </Button>
    
                                                               <Button Command="{Binding ShowMasterBrowserCommand}"
                                                                       CommandParameter="Left" 
                                                                       Classes="actionBtn"
                                                                       Width="20" Height="20" MinHeight="0" Padding="0"
                                                                       Background="#330055FF" CornerRadius="0" BorderThickness="0"
                                                                       Cursor="Hand" ToolTip.Tip="Buka Master File Browser">
                                                                   <PathIcon Data="{StaticResource IconFolder}" Width="10" Height="10" Foreground="{DynamicResource AccentBlueBrush}"/>
                                                               </Button>
                                                               <!-- MASTER FILE BROWSER (Removed) -->
                                                           </StackPanel>
                                                       </Panel>
                                                       
                                                       <!-- 3. FOLDER ICON (Hidden if not directory OR if Input is Visible) -->
                                                       <!-- 3. FOLDER ICON (Hidden if not directory OR if Input is Visible) -->
                                                       <!-- <PathIcon Data="{StaticResource IconFile}" ... /> -->
    
                                                       <!-- 4. ITEM NAME (Visible when Input is HIDDEN) -->
                                                       <TextBlock Text="{Binding Name}" FontSize="11" Foreground="{DynamicResource TextPrimaryBrush}" 
                                                                  VerticalAlignment="Center" PointerPressed="OnNodePointerPressed" Cursor="Hand"
                                                                  IsVisible="{Binding !IsNewFolderInputVisible}"/>
                                                                  
                                                       <!-- 5. INLINE INPUT (Visible when Input is SHOWN) -->
                                                       <Grid IsVisible="{Binding IsNewFolderInputVisible}" Margin="0,-4">
                                                           <Grid.ColumnDefinitions>
                                                               <ColumnDefinition Width="90"/>
                                                               <ColumnDefinition Width="Auto"/>
                                                               <ColumnDefinition Width="Auto"/>
                                                           </Grid.ColumnDefinitions>
                                                           <TextBox Grid.Column="0" Text="{Binding NewSubFolderName, Mode=TwoWay}" 
                                                                    Watermark="Name..." FontSize="11" VerticalAlignment="Center" MinHeight="0" Height="22" Padding="4,2">
                                                               <TextBox.KeyBindings>
                                                                   <KeyBinding Gesture="Enter" Command="{Binding ConfirmNewFolderCommand}"/>
                                                               </TextBox.KeyBindings>
                                                           </TextBox>
                                                           <Button Grid.Column="1" Command="{Binding ConfirmNewFolderCommand}" Content="" FontSize="10" Width="20" Height="20" MinHeight="0" Padding="0" Margin="2,0" Background="{DynamicResource AccentBlueBrush}" Foreground="White"/>
                                                           <Button Grid.Column="2" Command="{Binding CancelActionCommand}" Content="" FontSize="10" Width="20" Height="20" MinHeight="0" Padding="0" Background="Transparent" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                                       </Grid>
                                                  </StackPanel>
                                              </TreeDataTemplate>
                                          </TreeView.DataTemplates>
                                          <TreeView.Styles>
                                              <Style Selector="TreeViewItem">
                                                   <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}"/>
                                                   <Setter Property="MinHeight" Value="18"/> <!-- Adjusted spacing (was 24) -->
                                                   <Setter Property="Padding" Value="0"/>
                                                   <Setter Property="Margin" Value="0"/>
                                              </Style>
                                              <!-- HIDE DEFAULT EXPANDER CHEVRON -->
                                              <Style Selector="TreeViewItem /template/ ToggleButton#PART_ExpandCollapseChevron">
                                                  <Setter Property="IsVisible" Value="False"/>
                                                  <Setter Property="Width" Value="0"/>
                                                  <Setter Property="MinWidth" Value="0"/>
                                              </Style>
                                              <!-- FLATTEN HIERARCHY: REMOVE INDENTATION -->
                                              <Style Selector="TreeViewItem /template/ ItemsPresenter#PART_ItemsPresenter">
                                                  <Setter Property="Margin" Value="0"/>
                                              </Style>
    
                                              <!-- DISABLE HOVER EFFECT -->
                                              <Style Selector="TreeViewItem:pointerover /template/ Border#PART_LayoutRoot">
                                                  <Setter Property="Background" Value="Transparent"/>
                                              </Style>
                                          </TreeView.Styles>
                                    </TreeView>
                                    
                                    <!-- MASTER FILE BROWSER PANEL (LEFT) -->
                                    <Grid IsVisible="{Binding BatchVM.IsMasterBrowserOpenLeft}" RowDefinitions="Auto, Auto, *">
                                        <!-- Header -->
                                        <Grid ColumnDefinitions="*, Auto" Margin="0,0,0,10">
                                            <StackPanel>
                                                <TextBlock Text="COPY TO" FontSize="10" FontWeight="Bold" Foreground="#888"/>
                                                <TextBlock Text="{Binding BatchVM.MasterBrowserTargetName}" FontWeight="Bold" Foreground="{DynamicResource TextPrimaryBrush}" TextTrimming="CharacterEllipsis"/>
                                            </StackPanel>
                                            <Button Grid.Column="1" Command="{Binding BatchVM.CloseMasterBrowserCommand}" Classes="Clear" Padding="5">
                                                <PathIcon Data="{StaticResource IconX}" Width="12" Height="12"/>
                                            </Button>
                                        </Grid>
                                        
                                        <!-- Search -->
                                        <TextBox Grid.Row="1" Text="{Binding BatchVM.MasterSearchText, Mode=TwoWay}" Watermark="Cari Master..." Classes="searchBox" Margin="0,0,0,10"/>
                                        
                                        <!-- Files Tree -->
                                        <TreeView Grid.Row="2" ItemsSource="{Binding BatchVM.MasterNodes}"
                                                  Classes="PlainTree"
                                                  SelectionMode="Single"
                                                  ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                                                  Background="Transparent" BorderThickness="0">
                                            <TreeView.ItemTemplate>
                                                <TreeDataTemplate DataType="{x:Type models:MasterNode}" ItemsSource="{Binding Children}">
                                                    <Grid ColumnDefinitions="Auto,*" Background="Transparent" ToolTip.Tip="{Binding FullPath}">
                                                        <!-- Double Click Behavior -->
                                                        <Interaction.Behaviors>
                                                            <EventTriggerBehavior EventName="DoubleTapped">
                                                                <InvokeCommandAction Command="{Binding DataContext.BatchVM.CopyMasterFileCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                                                     CommandParameter="{Binding}"/>
                                                            </EventTriggerBehavior>
                                                        </Interaction.Behaviors>
                                                        
                                                        <!-- Icon (Only for File) -->
                                                        <PathIcon Data="{StaticResource IconFile}"
                                                                  Classes.file="{Binding !IsDirectory}"
                                                                  IsVisible="{Binding !IsDirectory}"
                                                                  Width="12" Height="12" Margin="0,1,6,0"
                                                                  VerticalAlignment="Center"/>
                                                        
                                                        <!-- Name -->
                                                        <TextBlock Grid.Column="1" Text="{Binding Name}" 
                                                                   VerticalAlignment="Center"
                                                                   FontSize="11"
                                                                   Foreground="{DynamicResource TextPrimaryBrush}"
                                                                   TextTrimming="CharacterEllipsis"/>
                                                    </Grid>
                                                </TreeDataTemplate>
                                            </TreeView.ItemTemplate>
                                        </TreeView>

                                    </Grid>
                                </Grid>
                            </Border>
                            
                            <!-- Header Label -->
                            <Border VerticalAlignment="Top" HorizontalAlignment="Left" Margin="20,0,0,0" Background="{DynamicResource CardBackgroundBrush}" Padding="6,0" CornerRadius="4">
                                <TextBlock Text="PILIHAN (TREE)" FontWeight="Bold" FontSize="10" Foreground="{DynamicResource AccentBlueBrush}" VerticalAlignment="Center"/>
                            </Border>
                            
                            <!-- Add Folder Button (Source) - Left Aligned -->
                            <Button VerticalAlignment="Bottom" HorizontalAlignment="Left" Margin="20,0,0,0"
                                    Width="28" Height="28" CornerRadius="6" Padding="0"
                                    Background="{DynamicResource CardBackgroundBrush}"
                                    BorderBrush="{DynamicResource CardBorderBrush}" BorderThickness="1"
                                    ToolTip.Tip="Create New Source Folder"
                                    Cursor="Hand">
                                <Button.Styles>
                                    <Style Selector="Button:pointerover /template/ ContentPresenter#PART_ContentPresenter">
                                        <Setter Property="Background" Value="{DynamicResource AccentBlueBrush}"/>
                                        <Setter Property="BorderBrush" Value="{DynamicResource AccentBlueBrush}"/>
                                    </Style>
                                    <Style Selector="Button:pointerover PathIcon">
                                        <Setter Property="Foreground" Value="White"/>
                                    </Style>
                                </Button.Styles>
                                <Button.Flyout>
                                    <Flyout Placement="TopEdgeAlignedRight" ShowMode="TransientWithDismissOnPointerMoveAway">
                                        <!-- Solid Background Wrapper -->
                                        <Border Background="{DynamicResource CardBackgroundBrush}" Padding="10" CornerRadius="8" BorderBrush="{DynamicResource CardBorderBrush}" BorderThickness="1">
                                            <StackPanel Spacing="10" Width="200">
                                                <TextBlock Text="New Source Folder" FontWeight="Bold" FontSize="12"/>
                                                <TextBox Text="{Binding BatchVM.NewFolderName, Mode=TwoWay}" Watermark="Folder Name..." CornerRadius="6" FontSize="12"/>
                                                <Button Command="{Binding BatchVM.CreateFolderCommand}" CommandParameter="Source"
                                                        Content="Create" HorizontalAlignment="Stretch" HorizontalContentAlignment="Center"
                                                        Background="{DynamicResource AccentBlueBrush}" Foreground="White" CornerRadius="6"/>
                                            </StackPanel>
                                        </Border>
                                    </Flyout>
                                </Button.Flyout>
                                <PathIcon Data="M13,9H18.5L13,3.5V9M6,2H14L20,8V20A2,2 0 0,1 18,22H6C4.89,22 4,21.1 4,20V4C4,2.89 4.89,2 6,2M11,15V12H9V15H6V17H9V20H11V17H14V15H11Z" Width="14" Height="14" Foreground="{DynamicResource TextSecondaryBrush}"/>
                            </Button>
                        </Grid>
                        
                        <!-- OUTPUT PANEL -->
                        <Grid Grid.Column="1" Margin="5,0,0,0">
                            <!-- Adjusted margin bottom to 14 to allow button overlap -->
                            <Border Background="{DynamicResource CardBackgroundBrush}" CornerRadius="20" Padding="10" Margin="0,8,0,14" BorderBrush="{DynamicResource CardBorderBrush}" BorderThickness="1">
                                <Grid>
                                    <TreeView ItemsSource="{Binding BatchVM.SourceFolders}"
                                              SelectedItem="{Binding BatchVM.SelectedBatchItem, Mode=TwoWay}"
                                              IsVisible="{Binding !BatchVM.IsMasterBrowserOpenRight}"
                                              SelectionMode="Single"
                                              ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                                              Background="Transparent" BorderThickness="0">
                                          <TreeView.DataTemplates>
                                              <!-- ROOT LEVEL TEMPLATE -->
                                              <TreeDataTemplate DataType="{x:Type vm:BatchFolderRoot}" ItemsSource="{Binding OutputRoot.Children}">
                                                  <StackPanel Orientation="Horizontal" Spacing="2">
                                                       <!-- MENU BUTTON -->
                                                       <Button Width="20" Height="20" MinHeight="0" Padding="0" Background="Transparent" BorderThickness="0" Cursor="Hand" VerticalAlignment="Center" Margin="0,0,4,0">
                                                           <PathIcon Data="M12,16A2,2 0 0,1 14,18A2,2 0 0,1 12,20A2,2 0 0,1 10,18A2,2 0 0,1 12,16M12,10A2,2 0 0,1 14,12A2,2 0 0,1 12,14A2,2 0 0,1 10,12A2,2 0 0,1 12,10M12,4A2,2 0 0,1 14,6A2,2 0 0,1 12,8A2,2 0 0,1 10,6A2,2 0 0,1 12,4Z" Width="10" Height="10" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                                           <Button.Flyout>
                                                               <Flyout Placement="BottomEdgeAlignedLeft" ShowMode="TransientWithDismissOnPointerMoveAway">
                                                                   <Border Background="{DynamicResource CardBackgroundBrush}" Padding="8" CornerRadius="6" BorderBrush="{DynamicResource CardBorderBrush}" BorderThickness="1">
                                                                       <StackPanel Spacing="8" Width="160">
                                                                           <TextBlock Text="Folder Options" FontWeight="Bold" FontSize="10" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                                                           <!-- Create Subfolder -->
                                                                           <StackPanel Spacing="4">
                                                                               <TextBox Text="{Binding NewSubFolderName, Mode=TwoWay}" Watermark="New Subfolder Name..." FontSize="11" CornerRadius="4"/>
                                                                               <Button Content="Add Subfolder" Command="{Binding CreateSubFolderCommand}" HorizontalAlignment="Stretch" HorizontalContentAlignment="Center" FontSize="11"/>
                                                                           </StackPanel>
                                                                           <Separator Height="1" Background="{DynamicResource CardBorderBrush}"/>
                                                                           <!-- Delete -->
                                                                           <Button Content="Delete Folder" Command="{Binding DeleteCommand}" HorizontalAlignment="Stretch" HorizontalContentAlignment="Center" FontSize="11" Foreground="Red" Background="#1AFF0000" BorderBrush="Red" BorderThickness="1" CornerRadius="4"/>
                                                                       </StackPanel>
                                                                   </Border>
                                                               </Flyout>
                                                           </Button.Flyout>
                                                       </Button>
                                                       
                                                       <TextBlock Text="{Binding OutputHeader}" FontWeight="SemiBold" FontSize="11" Foreground="{DynamicResource TextPrimaryBrush}" VerticalAlignment="Center" PointerPressed="OnNodePointerPressed" Cursor="Hand"/>
                                                       <TextBlock Text="(pending)" FontSize="10" Foreground="{DynamicResource TextSecondaryBrush}" IsVisible="{Binding OutputRoot, Converter={x:Static ObjectConverters.IsNull}}" VerticalAlignment="Center"/>
                                                  </StackPanel>
                                              </TreeDataTemplate>
    
                                              <!-- CHILD LEVEL TEMPLATE -->
                                              <TreeDataTemplate DataType="{x:Type vm:BatchNodeItem}" ItemsSource="{Binding Children}">
                                                  <StackPanel Orientation="Horizontal" Spacing="2">
                                                       <!-- INLINE ACTION BAR & TOGGLE -->
                                                       <Panel VerticalAlignment="Center" Margin="0,0,4,0">
                                                           <!-- 1. TOGGLE BUTTON (Visible when Action Bar CLOSED and Input CLOSED) -->
                                                           <Button Command="{Binding ToggleActionBarCommand}"
                                                                   IsVisible="{Binding !IsActionBarOpen}"
                                                                   Width="20" Height="20" MinHeight="0" Padding="0" 
                                                                   Background="Transparent" BorderThickness="0" 
                                                                   Cursor="Hand">
                                                               <Button.IsVisible>
                                                                   <MultiBinding Converter="{x:Static BoolConverters.And}">
                                                                       <Binding Path="!IsActionBarOpen"/>
                                                                       <Binding Path="!IsNewFolderInputVisible"/>
                                                                   </MultiBinding>
                                                               </Button.IsVisible>
                                                               <PathIcon Data="M12,16A2,2 0 0,1 14,18A2,2 0 0,1 12,20A2,2 0 0,1 10,18A2,2 0 0,1 12,16M12,10A2,2 0 0,1 14,12A2,2 0 0,1 12,14A2,2 0 0,1 10,12A2,2 0 0,1 12,10M12,4A2,2 0 0,1 14,6A2,2 0 0,1 12,8A2,2 0 0,1 10,6A2,2 0 0,1 12,4Z" 
                                                                         Width="10" Height="10" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                                           </Button>
    
                                                           <!-- 2. ACTION BAR (Visible when OPEN) -->
                                                           <StackPanel Orientation="Horizontal" Spacing="6" IsVisible="{Binding IsActionBarOpen}">
                                                               <StackPanel.Styles>
                                                                   <Style Selector="Button.actionBtn:pointerover /template/ ContentPresenter#PART_ContentPresenter">
                                                                       <Setter Property="Background" Value="{Binding $parent[Button].Background}"/>
                                                                   </Style>
                                                               </StackPanel.Styles>
                                                               
                                                               <!-- CLOSE (X) -->
                                                               <Button Command="{Binding CancelActionCommand}"
                                                                       Classes="actionBtn"
                                                                       Width="20" Height="20" MinHeight="0" Padding="0"
                                                                       Background="#303030" CornerRadius="0" BorderThickness="0"
                                                                       Cursor="Hand" ToolTip.Tip="Cancel">
                                                                   <PathIcon Data="{StaticResource IconX}" Width="10" Height="10" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                                               </Button>
                                                               
                                                               <!-- NEW FOLDER (Only for Directories) -->
                                                               <Button Command="{Binding ShowNewFolderInputCommand}"
                                                                       Classes="actionBtn"
                                                                       IsVisible="{Binding IsDirectory}"
                                                                       Width="20" Height="20" MinHeight="0" Padding="0"
                                                                       Background="#303030" CornerRadius="0" BorderThickness="0"
                                                                       Cursor="Hand" ToolTip.Tip="New Subfolder">
                                                                   <Grid>
                                                                       <PathIcon Data="{StaticResource IconFolder}" Width="10" Height="10" Foreground="{DynamicResource TextPrimaryBrush}"/>
                                                                       <PathIcon Data="{StaticResource IconPlus}" Width="6" Height="6" Foreground="{DynamicResource AccentBlueBrush}" VerticalAlignment="Center" HorizontalAlignment="Center" Margin="0,2,0,0"/>
                                                                   </Grid>
                                                               </Button>
                                                               
                                                               <!-- DELETE -->
                                                               <Button Command="{Binding DeleteCommand}"
                                                                       Classes="actionBtn"
                                                                       Width="20" Height="20" MinHeight="0" Padding="0"
                                                                       Background="#33FF0000" CornerRadius="0" BorderThickness="0"
                                                                       Cursor="Hand" ToolTip.Tip="Delete Item">
                                                                   <PathIcon Data="{StaticResource IconTrash}" Width="12" Height="12" Foreground="#FF5555"/>
                                                               </Button>
    
                                                               <Button Command="{Binding ShowMasterBrowserCommand}"
                                                                       CommandParameter="Right" 
                                                                       Classes="actionBtn"
                                                                       Width="20" Height="20" MinHeight="0" Padding="0"
                                                                       Background="#330055FF" CornerRadius="0" BorderThickness="0"
                                                                       Cursor="Hand" ToolTip.Tip="Buka Master File Browser">
                                                                   <PathIcon Data="{StaticResource IconFolder}" Width="10" Height="10" Foreground="{DynamicResource AccentBlueBrush}"/>
                                                               </Button>
                                                               <!-- MASTER FILE BROWSER (Removed) -->
                                                           </StackPanel>
                                                       </Panel>
    
                                                       <!-- 3. FOLDER ICON (Hidden if not directory OR if Input is Visible) -->
                                                       <!-- 3. FOLDER ICON (Hidden if not directory OR if Input is Visible) -->
                                                       <!-- <PathIcon Data="{StaticResource IconFile}" ... /> -->
    
                                                       <!-- 4. ITEM NAME (Visible when Input is HIDDEN) -->
                                                       <TextBlock Text="{Binding Name}" FontSize="11" Foreground="{DynamicResource TextPrimaryBrush}" 
                                                                  VerticalAlignment="Center" PointerPressed="OnNodePointerPressed" Cursor="Hand"
                                                                  IsVisible="{Binding !IsNewFolderInputVisible}"/>
                                                                  
                                                       <!-- 5. INLINE INPUT (Visible when Input is SHOWN) -->
                                                       <Grid IsVisible="{Binding IsNewFolderInputVisible}" Margin="0,-4">
                                                           <Grid.ColumnDefinitions>
                                                               <ColumnDefinition Width="90"/>
                                                               <ColumnDefinition Width="Auto"/>
                                                               <ColumnDefinition Width="Auto"/>
                                                           </Grid.ColumnDefinitions>
                                                           <TextBox Grid.Column="0" Text="{Binding NewSubFolderName, Mode=TwoWay}" 
                                                                    Watermark="Name..." FontSize="11" VerticalAlignment="Center" MinHeight="0" Height="22" Padding="4,2"/>
                                                           <Button Grid.Column="1" Command="{Binding ConfirmNewFolderCommand}" Content="" FontSize="10" Width="20" Height="20" MinHeight="0" Padding="0" Margin="2,0" Background="{DynamicResource AccentBlueBrush}" Foreground="White"/>
                                                           <Button Grid.Column="2" Command="{Binding CancelActionCommand}" Content="" FontSize="10" Width="20" Height="20" MinHeight="0" Padding="0" Background="Transparent" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                                       </Grid>
                                                  </StackPanel>
                                              </TreeDataTemplate>
                                          </TreeView.DataTemplates>
                                          <TreeView.Styles>
                                              <Style Selector="TreeViewItem">
                                                   <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}"/>
                                                   <Setter Property="MinHeight" Value="18"/>
                                                   <Setter Property="Padding" Value="0"/>
                                                   <Setter Property="Margin" Value="0"/>
                                              </Style>
                                              <!-- HIDE DEFAULT EXPANDER CHEVRON -->
                                              <Style Selector="TreeViewItem /template/ ToggleButton#PART_ExpandCollapseChevron">
                                                  <Setter Property="IsVisible" Value="False"/>
                                                  <Setter Property="Width" Value="0"/>
                                                  <Setter Property="MinWidth" Value="0"/>
                                              </Style>
                                              <!-- FLATTEN HIERARCHY -->
                                              <Style Selector="TreeViewItem /template/ ItemsPresenter#PART_ItemsPresenter">
                                                  <Setter Property="Margin" Value="0"/>
                                              </Style>
    
                                              <!-- DISABLE HOVER EFFECT -->
                                              <Style Selector="TreeViewItem:pointerover /template/ Border#PART_LayoutRoot">
                                                  <Setter Property="Background" Value="Transparent"/>
                                              </Style>
                                          </TreeView.Styles>
                                    </TreeView>
                                    
                                    <!-- MASTER FILE BROWSER PANEL (RIGHT) -->
                                    <Grid IsVisible="{Binding BatchVM.IsMasterBrowserOpenRight}" RowDefinitions="Auto, Auto, *">
                                        <!-- Header -->
                                        <Grid ColumnDefinitions="*, Auto" Margin="0,0,0,10">
                                            <StackPanel>
                                                <TextBlock Text="COPY TO" FontSize="10" FontWeight="Bold" Foreground="#888"/>
                                                <TextBlock Text="{Binding BatchVM.MasterBrowserTargetName}" FontWeight="Bold" Foreground="{DynamicResource TextPrimaryBrush}" TextTrimming="CharacterEllipsis"/>
                                            </StackPanel>
                                            <Button Grid.Column="1" Command="{Binding BatchVM.CloseMasterBrowserCommand}" Classes="Clear" Padding="5">
                                                <PathIcon Data="{StaticResource IconX}" Width="12" Height="12"/>
                                            </Button>
                                        </Grid>
                                        
                                        <!-- Search -->
                                        <TextBox Grid.Row="1" Text="{Binding BatchVM.MasterSearchText, Mode=TwoWay}" Watermark="Cari Master..." Classes="searchBox" Margin="0,0,0,10"/>
                                        
                                        <!-- Files Tree -->
                                        <TreeView Grid.Row="2" ItemsSource="{Binding BatchVM.MasterNodes}"
                                                  Classes="PlainTree"
                                                  SelectionMode="Single"
                                                  ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                                                  Background="Transparent" BorderThickness="0">
                                            <TreeView.ItemTemplate>
                                                <TreeDataTemplate DataType="{x:Type models:MasterNode}" ItemsSource="{Binding Children}">
                                                    <Grid ColumnDefinitions="Auto,*" Background="Transparent" ToolTip.Tip="{Binding FullPath}">
                                                        <Interaction.Behaviors>
                                                            <EventTriggerBehavior EventName="DoubleTapped">
                                                                <InvokeCommandAction Command="{Binding DataContext.BatchVM.CopyMasterFileCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                                                     CommandParameter="{Binding}"/>
                                                            </EventTriggerBehavior>
                                                        </Interaction.Behaviors>
                                                        
                                                        <!-- Icon (Only for File) -->
                                                        <PathIcon Data="{StaticResource IconFile}"
                                                                  Classes.file="{Binding !IsDirectory}"
                                                                  IsVisible="{Binding !IsDirectory}"
                                                                  Width="12" Height="12" Margin="0,1,6,0"
                                                                  VerticalAlignment="Center"/>
                                                        
                                                        <!-- Name -->
                                                        <TextBlock Grid.Column="1" Text="{Binding Name}" 
                                                                   VerticalAlignment="Center"
                                                                   FontSize="11"
                                                                   Foreground="{DynamicResource TextPrimaryBrush}"
                                                                   TextTrimming="CharacterEllipsis"/>
                                                    </Grid>
                                                </TreeDataTemplate>
                                            </TreeView.ItemTemplate>
                                        </TreeView>

                                    </Grid>
                                </Grid>
                            </Border>
                            
                            <!-- Header Label -->
                            <Border VerticalAlignment="Top" HorizontalAlignment="Right" Margin="0,0,20,0" Background="{DynamicResource CardBackgroundBrush}" Padding="6,0" CornerRadius="4">
                                <TextBlock Text="OUTPUT LOKAL" FontWeight="Bold" FontSize="10" Foreground="{DynamicResource TextPrimaryBrush}" VerticalAlignment="Center"/>
                            </Border>

                            <!-- Add Folder Button (Output) - Right Aligned -->
                            <Button VerticalAlignment="Bottom" HorizontalAlignment="Right" Margin="0,0,20,0"
                                    Width="28" Height="28" CornerRadius="6" Padding="0"
                                    Background="{DynamicResource CardBackgroundBrush}"
                                    BorderBrush="{DynamicResource CardBorderBrush}" BorderThickness="1"
                                    ToolTip.Tip="Create New Output Folder"
                                    Cursor="Hand">
                                <Button.Styles>
                                    <Style Selector="Button:pointerover /template/ ContentPresenter#PART_ContentPresenter">
                                        <Setter Property="Background" Value="{DynamicResource AccentBlueBrush}"/>
                                        <Setter Property="BorderBrush" Value="{DynamicResource AccentBlueBrush}"/>
                                    </Style>
                                    <Style Selector="Button:pointerover PathIcon">
                                        <Setter Property="Foreground" Value="White"/>
                                    </Style>
                                </Button.Styles>
                                <Button.Flyout>
                                    <Flyout Placement="TopEdgeAlignedRight" ShowMode="TransientWithDismissOnPointerMoveAway">
                                        <!-- Solid Background Wrapper -->
                                        <Border Background="{DynamicResource CardBackgroundBrush}" Padding="10" CornerRadius="8" BorderBrush="{DynamicResource CardBorderBrush}" BorderThickness="1">
                                            <StackPanel Spacing="10" Width="200">
                                                <TextBlock Text="New Output Folder" FontWeight="Bold" FontSize="12"/>
                                                <TextBox Text="{Binding BatchVM.NewFolderName, Mode=TwoWay}" Watermark="Folder Name..." CornerRadius="6" FontSize="12"/>
                                                <Button Command="{Binding BatchVM.CreateFolderCommand}" CommandParameter="Output"
                                                        Content="Create" HorizontalAlignment="Stretch" HorizontalContentAlignment="Center"
                                                        Background="{DynamicResource AccentBlueBrush}" Foreground="White" CornerRadius="6"/>
                                            </StackPanel>
                                        </Border>
                                    </Flyout>
                                </Button.Flyout>
                                <PathIcon Data="M13,9H18.5L13,3.5V9M6,2H14L20,8V20A2,2 0 0,1 18,22H6C4.89,22 4,21.1 4,20V4C4,2.89 4.89,2 6,2M11,15V12H9V15H6V17H9V20H11V17H14V15H11Z" Width="14" Height="14" Foreground="{DynamicResource TextSecondaryBrush}"/>
                            </Button>
                        </Grid>
                    </Grid>
                    
                    <!-- NEW FOOTER LAYOUT (REDESIGNED) -->
                    <Border Grid.Row="1" Margin="0,10,0,0" 
                            Background="{DynamicResource CardBackgroundBrush}" 
                            CornerRadius="12,12,0,0" Padding="15,10"
                            BorderBrush="{DynamicResource CardBorderBrush}" BorderThickness="1,1,1,0"
                            IsVisible="{Binding BatchVM.HasFolders}">
                            <Grid ColumnDefinitions="*, Auto">
                                <!-- Horizontal Scrollable Master Buttons -->
                                <ScrollViewer Grid.Column="0" HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Disabled" Margin="0,0,10,0">
                                    <StackPanel Orientation="Horizontal" Spacing="10">
                                        
                                        <!-- Master ItemsControl -->
                                        <ItemsControl ItemsSource="{Binding BatchVM.MasterScriptOrderList}">
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <StackPanel Orientation="Horizontal" Spacing="8"/>
                                                </ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Button Command="{Binding DataContext.BatchVM.ExecuteSpecificMasterCommand, ElementName=Root}"
                                                            CommandParameter="{Binding}"
                                                            Width="32" Height="32" Padding="0" CornerRadius="8" Cursor="Hand"
                                                            Background="#2A2A2A" BorderThickness="0"
                                                            ToolTip.Tip="{Binding Name}">
                                                        <Button.Styles>
                                                            <Style Selector="Button:pointerover /template/ ContentPresenter#PART_ContentPresenter">
                                                                <Setter Property="Background" Value="{DynamicResource AccentBlueBrush}"/>
                                                            </Style>
                                                        </Button.Styles>
                                                        <Panel>
                                                            <!-- Icon -->
                                                            <PathIcon Data="{Binding IconGeometry}" Width="16" Height="16" Foreground="White"
                                                                      HorizontalAlignment="Center" VerticalAlignment="Center" IsVisible="{Binding IconGeometry, Converter={x:Static ObjectConverters.IsNotNull}}"/>
                                                            <!-- Failover Generic Icon if null -->
                                                            <PathIcon Data="{StaticResource IconScript}" Width="16" Height="16" Foreground="White"
                                                                      HorizontalAlignment="Center" VerticalAlignment="Center" IsVisible="{Binding IconGeometry, Converter={x:Static ObjectConverters.IsNull}}"/>
                                                        </Panel>
                                                    </Button>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </StackPanel>
                                </ScrollViewer>
                                
                                <!-- Utility Buttons (Right) -->
                                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="5" VerticalAlignment="Center">
                                    <!-- Scripts Path Button -->
                                    <Button Command="{Binding BatchVM.BrowseScriptsFolderCommand}" 
                                            Width="32" Height="32" Padding="0"
                                            Background="Transparent" BorderBrush="{DynamicResource CardBorderBrush}" BorderThickness="1"
                                            CornerRadius="4" ToolTip.Tip="Set Scripts Folder">
                                        <shapes:Path Data="M10,4H4C2.89,4 2,4.89 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V8C22,6.89 21.1,6 20,6H12L10,4Z" 
                                                     Width="14" Height="14" Fill="{DynamicResource AccentBlueBrush}" Stretch="Uniform"/>
                                    </Button>
                                    
                                    <!-- Clear Button -->
                                    <Button Command="{Binding BatchVM.ClearCommand}" 
                                            Width="32" Height="32" Padding="0"
                                            Background="Transparent" BorderBrush="{DynamicResource CardBorderBrush}" BorderThickness="1"
                                            CornerRadius="4" ToolTip.Tip="Clear All">
                                        <PathIcon Data="{StaticResource IconTrash}" Width="16" Height="16" Foreground="{DynamicResource AccentRedBrush}"/>
                                    </Button>
                                </StackPanel>
                            </Grid>
                    </Border>
                </Grid>

                <!-- LOCKER TAB CONTENT -->
                <views:FolderLockerView DataContext="{Binding FolderLockerVM}" 
                                        IsVisible="{Binding DataContext.IsLockerTabSelected, ElementName=Root}" 
                                        Margin="20,0,20,0"/>
                                        
                <!-- PIXELCUT TAB CONTENT -->
                <views:CompactPixelcutView DataContext="{Binding PixelcutVM}"
                                           IsVisible="{Binding DataContext.IsPixelcutTabSelected, ElementName=Root}"
                                           Margin="20,0,20,0"/>

                <!-- EXPLORER TAB CONTENT -->
                <views:OutputExplorerView DataContext="{Binding OutputExplorerVM}"
                                          IsVisible="{Binding DataContext.IsExplorerTabSelected, ElementName=Root}"
                                          Margin="20,0,20,0"/>

                <!-- GDRIVE TAB CONTENT -->
                <views:CompactGdriveView DataContext="{Binding GdriveVM}"
                                         IsVisible="{Binding DataContext.IsGdriveTabSelected, ElementName=Root}"
                                         Margin="20,0,20,0"/>

                <!-- EMBEDDED VIEW OVERLAY -->
                <Grid IsVisible="{Binding IsEmbeddedViewOpen}" Background="{DynamicResource AppBackgroundBrush}" ZIndex="100">
                    <ContentControl Content="{Binding CurrentEmbeddedView}" 
                                    PointerPressed="OnEmbeddedViewPointerPressed"/>
                </Grid>
        </Grid>
    </Grid>

    <!-- GRID SPLITTER (DISABLED) -->
    <GridSplitter Grid.Column="2" Width="0" HorizontalAlignment="Stretch" Background="Transparent" 
                  ResizeDirection="Columns" IsVisible="False"/>

    <!-- LOG PANEL (NOW RIGHT) -->
    <views:LogPanelSidebar Grid.Column="3" Width="279"
                           IsVisible="{Binding IsLogPanelOpen}" 
                           VerticalAlignment="Stretch"/>
</Grid>
</UserControl>
