<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:controls="clr-namespace:BMachine.UI.Controls"
             xmlns:views="using:BMachine.UI.Views"
             xmlns:shapes="using:Avalonia.Controls.Shapes"
             mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="800"
             x:Class="BMachine.UI.Views.DashboardView"
             x:Name="Root">
             
    <UserControl.Styles>
        <!-- Custom Style for Pill Menu Flyout -->
        <Style Selector="FlyoutPresenter">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="CornerRadius" Value="18"/>
            <Setter Property="MinWidth" Value="0"/>
            <Setter Property="Margin" Value="0,4,0,0"/>
        </Style>
    </UserControl.Styles>

    
    <Grid ColumnDefinitions="*, 4, Auto">
        
        <!-- MAIN DASHBOARD AREA (Header + Content) -->
        <Grid Grid.Column="0" RowDefinitions="Auto, Auto, *" MinWidth="479">
            <!-- HEADER -->
            <Grid Grid.Row="0" ColumnDefinitions="*, Auto" Margin="20,20,20,10">
                <!-- Greeting -->
                <!-- Profile (Moved to Left) -->
                <StackPanel Orientation="Horizontal" Spacing="12" VerticalAlignment="Center">
                     <Border Width="38" Height="38" CornerRadius="19" Background="{DynamicResource CardBackgroundBrush}" ClipToBounds="True" BorderBrush="{DynamicResource CardBorderBrush}" BorderThickness="1">
                         <Panel>
                             <shapes:Path Data="{StaticResource IconUser}" Width="20" Height="20" Fill="{DynamicResource TextSecondaryBrush}" Stretch="Uniform" HorizontalAlignment="Center" VerticalAlignment="Center"
                                          IsVisible="{Binding UserAvatar, Converter={x:Static ObjectConverters.IsNull}}"/>
                             <Image Source="{Binding UserAvatar}" Stretch="UniformToFill"
                                    IsVisible="{Binding UserAvatar, Converter={x:Static ObjectConverters.IsNotNull}}"/>
                         </Panel>
                     </Border>
                     <StackPanel VerticalAlignment="Center">
                         <TextBlock Text="{Binding UserName}" FontWeight="Bold" Foreground="{DynamicResource TextPrimaryBrush}" FontSize="14"/>
                         <TextBlock Text="{Binding Greeting}" Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12"/>
                     </StackPanel>
                </StackPanel>
                
                <!-- User Profile & Actions -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="20" VerticalAlignment="Center">

                    
                                        <!-- Actions Group -->
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        
                        <!-- Pixelcut Button -->
                        <Button Click="OnPixelcutClick" Width="32" Height="32" CornerRadius="8"
                                Background="{DynamicResource AccentBlueBrush}" BorderThickness="0" Padding="0" Cursor="Hand" ToolTip.Tip="Pixelcut Batch">
                            <shapes:Path Data="M21,19V5C21,3.89 20.1,3 19,3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19M8.5,13.5L11,16.5L14.5,12L19,18H5" 
                                         Width="16" Height="16" Fill="White" Stretch="Uniform"/>
                        </Button>

                        <!-- GDrive Button -->
                        <Button Click="OnGdriveClick" Width="32" Height="32" CornerRadius="8"
                                Background="{DynamicResource AccentBlueBrush}" BorderThickness="0" Padding="0" Cursor="Hand" ToolTip.Tip="Google Drive">
                             <PathIcon Data="{StaticResource IconCloud}" Width="16" Height="16" Foreground="White"/>
                        </Button>
                        


                        <!-- Smart Orb Toggle -->
                         <ToggleButton IsChecked="{Binding IsFloatingWidgetVisible}" 
                                      Width="32" Height="32" CornerRadius="8"
                                      ToolTip.Tip="Toggle Smart Orb"
                                      Cursor="Hand" Padding="0">
                            <ToggleButton.Styles>
                                <Style Selector="ToggleButton">
                                    <Setter Property="Background" Value="{DynamicResource CardBackgroundBrush}"/>
                                </Style>
                                <Style Selector="ToggleButton Path">
                                     <Setter Property="Fill" Value="{DynamicResource TextPrimaryBrush}"/>
                                </Style>
                                <Style Selector="ToggleButton:checked /template/ ContentPresenter#PART_ContentPresenter">
                                    <Setter Property="Background" Value="{DynamicResource AccentBlueBrush}"/>
                                </Style>
                                <Style Selector="ToggleButton:checked Path">
                                     <Setter Property="Fill" Value="White"/>
                                </Style>
                            </ToggleButton.Styles>
                            <shapes:Path Data="M12,2A10,10 0 1,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 1,1 4,12A8,8 0 0,1 12,4M12,6A6,6 0 1,0 18,12A6,6 0 0,0 12,6M12,8A4,4 0 1,1 8,12A4,4 0 0,1 12,8Z" 
                                         Width="16" Height="16" Stretch="Uniform"/>
                        </ToggleButton>
                        
                        <!-- Activity Panel Toggle (Bell Icon) -->
                        <ToggleButton Command="{Binding ToggleActivityPanelCommand}" 
                                      IsChecked="{Binding IsActivityPanelOpen, Mode=OneWay}"
                                      Width="32" Height="32" CornerRadius="8" Padding="0"
                                      ToolTip.Tip="Activity Log" Cursor="Hand">
                            <ToggleButton.Styles>
                                <Style Selector="ToggleButton">
                                    <Setter Property="Background" Value="{DynamicResource CardBackgroundBrush}"/>
                                </Style>
                                <Style Selector="ToggleButton Path">
                                     <Setter Property="Fill" Value="{DynamicResource TextPrimaryBrush}"/>
                                </Style>
                                <Style Selector="ToggleButton:checked /template/ ContentPresenter#PART_ContentPresenter">
                                    <Setter Property="Background" Value="{DynamicResource AccentBlueBrush}"/>
                                </Style>
                                <Style Selector="ToggleButton:checked Path">
                                     <Setter Property="Fill" Value="White"/>
                                </Style>
                            </ToggleButton.Styles>
                            <!-- Bell Icon -->
                            <shapes:Path Data="M12,22A2,2 0 0,0 14,20H10A2,2 0 0,0 12,22M18,16V11C18,7.93 16.36,5.36 13.5,4.68V4A1.5,1.5 0 0,0 12,2.5A1.5,1.5 0 0,0 10.5,4V4.68C7.63,5.36 6,7.92 6,11V16L4,18V19H20V18L18,16Z" 
                                         Width="16" Height="16" Stretch="Uniform"/>
                        </ToggleButton>
                        
                        <!-- Menu Button (Squircle 32px - Blue) -->
                        <Button Width="32" Height="32" 
                                Background="{DynamicResource AccentBlueBrush}" 
                                CornerRadius="8" Padding="0" BorderThickness="0" Cursor="Hand"
                                ToolTip.Tip="Menu">
                             <Button.Flyout>
                                 <Flyout Placement="Bottom" ShowMode="TransientWithDismissOnPointerMoveAway">
                                     <Border Background="{DynamicResource AccentBlueBrush}" CornerRadius="8" Padding="0,4" BoxShadow="0 4 12 0 #44000000">
                                         <StackPanel Orientation="Vertical" Spacing="0" Width="32">
                                             
                                              <!-- Log Panel Toggle (Previously Header) -->
                                             <ToggleButton Command="{Binding ToggleLogPanelCommand}" 
                                                           IsChecked="{Binding IsLogPanelOpen, Mode=OneWay}"
                                                           Width="32" Height="32" CornerRadius="8" Padding="0" 
                                                           Background="Transparent" BorderThickness="0" Cursor="Hand" ToolTip.Tip="Log Panel"
                                                           HorizontalContentAlignment="Center" VerticalContentAlignment="Center" HorizontalAlignment="Center">
                                                  <shapes:Path Data="M20,19V7H4V19H20M20,3A2,2 0 0,1 22,5V19A2,2 0 0,1 20,21H4A2,2 0 0,1 2,19V5C2,3.89 2.9,3 4,3H20M13,17V15H18V17H13M9.58,13L5.57,9H8.4L11.7,12.3C12.09,12.69 12.09,13.33 11.7,13.72L8.42,17H5.59L9.58,13Z" 
                                                               Width="14" Height="14" Fill="White" Stretch="Uniform"/>
                                             </ToggleButton>
                                             
                                             <!-- Settings Button (Top) -->
                                             <Button Click="OnSettingsClick" Width="32" Height="32" CornerRadius="8" Padding="0" Background="Transparent" BorderThickness="0" Cursor="Hand" ToolTip.Tip="Pengaturan"
                                                     HorizontalContentAlignment="Center" VerticalContentAlignment="Center" HorizontalAlignment="Center">
                                                 <PathIcon Data="{StaticResource IconSettings}" Width="16" Height="16" Foreground="White"/>
                                             </Button>
                                         </StackPanel>
                                     </Border>
                                 </Flyout>
                             </Button.Flyout>
                             <!-- Trigger Icon -->
                             <shapes:Path Data="M4,4H8V8H4V4M10,4H14V8H10V4M16,4H20V8H16V4M4,10H8V14H4V10M10,10H14V14H10V10M16,10H20V14H16V10M4,16H8V20H4V16M10,16H14V20H10V16M16,16H20V20H16V16Z" 
                                          Width="14" Height="14" Fill="White" Stretch="Uniform"/>
                        </Button>
                        
    
                    </StackPanel>
                </StackPanel>
            </Grid>
            
            <!-- NAVIGATION BAR -->
            <!-- Rounded Box Container (Segmented Control Container) -->
            <Border Grid.Row="1" HorizontalAlignment="Center" Background="{DynamicResource CardBackgroundBrush}" 
                    CornerRadius="12" Padding="4" Margin="20,0,20,2" BorderBrush="{DynamicResource CardBorderBrush}" BorderThickness="1">
                <StackPanel Orientation="Horizontal" Spacing="0">
                    
                    <!-- Locker Tab -->
                    <RadioButton GroupName="NavTabs" IsChecked="{Binding IsLockerTabSelected}"
                                 Padding="0" 
                                 Width="{Binding NavButtonWidth}" Height="{Binding NavButtonHeight}"
                                 Foreground="White" FontWeight="Bold"
                                 Opacity="0.6"
                                 Cursor="Hand"
                                 VerticalContentAlignment="Center" HorizontalContentAlignment="Center">
                        <PathIcon Data="M12,17A2,2 0 0,0 14,15C14,13.89 13.1,13 12,13A2,2 0 0,0 10,15A2,2 0 0,0 12,17M18,8H17V6A5,5 0 0,0 12,1H12A5,5 0 0,0 7,6V8H6A2,2 0 0,0 4,10V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V10A2,2 0 0,0 18,8M12,13A2,2 0 0,1 10,15A2,2 0 0,1 12,17A2,2 0 0,1 14,15A2,2 0 0,1 12,13M12,1A5,5 0 0,1 17,6V8H7V6A5,5 0 0,1 12,1Z"
                                  Width="{Binding NavFontSize}" Height="{Binding NavFontSize}" />
                        <RadioButton.Template>
                            <ControlTemplate>
                                <Border Background="{TemplateBinding Background}" 
                                        CornerRadius="{Binding DataContext.NavCornerRadiusStruct, ElementName=Root}"
                                        Padding="{TemplateBinding Padding}">
                                    <ContentPresenter Content="{TemplateBinding Content}" 
                                                      HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                </Border>
                            </ControlTemplate>
                        </RadioButton.Template>
                         <RadioButton.Styles>
                            <Style Selector="RadioButton">
                                <Setter Property="Background" Value="Transparent"/>
                                <Setter Property="Transitions">
                                    <Transitions>
                                        <BrushTransition Property="Background" Duration="0:0:0.15"/>
                                        <BrushTransition Property="Foreground" Duration="0:0:0.15"/>
                                    </Transitions>
                                </Setter>
                            </Style>
                            <Style Selector="RadioButton:checked">
                                <Setter Property="Background" Value="{DynamicResource AccentBlueBrush}"/>
                                <Setter Property="Foreground" Value="White"/>
                                <Setter Property="Opacity" Value="1.0"/>
                            </Style>
                             <Style Selector="RadioButton:pointerover">
                                <Setter Property="Foreground" Value="White"/>
                                <Setter Property="Opacity" Value="0.9"/>
                            </Style>
                             <Style Selector="RadioButton:checked:pointerover">
                                <Setter Property="Foreground" Value="White"/>
                                <Setter Property="Opacity" Value="1.0"/>
                            </Style>
                        </RadioButton.Styles>
                    </RadioButton>

                    <!-- Dashboard Tab -->
                    <RadioButton GroupName="NavTabs" IsChecked="{Binding IsDashboardTabSelected, Mode=TwoWay}"
                                 Padding="0" 
                                 Width="{Binding NavButtonWidth}" Height="{Binding NavButtonHeight}"
                                 Foreground="White" FontWeight="Bold"
                                 Opacity="0.6"
                                 Cursor="Hand"
                                 VerticalContentAlignment="Center" HorizontalContentAlignment="Center">
                        <PathIcon Data="M10,20V14H14V20H19V12H22L12,3L2,12H5V20H10Z"
                                  Width="{Binding NavFontSize}" Height="{Binding NavFontSize}" />
                        <RadioButton.Template>
                            <ControlTemplate>
                                <Border Background="{TemplateBinding Background}" 
                                        CornerRadius="{Binding DataContext.NavCornerRadiusStruct, ElementName=Root}"
                                        Padding="{TemplateBinding Padding}">
                                    <ContentPresenter Content="{TemplateBinding Content}" 
                                                      HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                </Border>
                            </ControlTemplate>
                        </RadioButton.Template>
                        <RadioButton.Styles>
                            <Style Selector="RadioButton">
                                <Setter Property="Background" Value="Transparent"/>
                                <Setter Property="Transitions">
                                    <Transitions>
                                        <BrushTransition Property="Background" Duration="0:0:0.15"/>
                                        <BrushTransition Property="Foreground" Duration="0:0:0.15"/>
                                    </Transitions>
                                </Setter>
                            </Style>
                            <Style Selector="RadioButton:checked">
                                <Setter Property="Background" Value="{DynamicResource AccentBlueBrush}"/>
                                <Setter Property="Foreground" Value="White"/>
                                <Setter Property="Opacity" Value="1.0"/>
                            </Style>
                            <Style Selector="RadioButton:pointerover">
                                <Setter Property="Foreground" Value="White"/>
                                <Setter Property="Opacity" Value="0.9"/>
                            </Style>
                             <Style Selector="RadioButton:checked:pointerover">
                                <Setter Property="Foreground" Value="White"/>
                                <Setter Property="Opacity" Value="1.0"/>
                            </Style>
                        </RadioButton.Styles>
                    </RadioButton>

                    <!-- Batch Tab -->
                    <RadioButton GroupName="NavTabs" IsChecked="{Binding IsBatchTabSelected}"
                                 Padding="0" 
                                 Width="{Binding NavButtonWidth}" Height="{Binding NavButtonHeight}"
                                 Foreground="White" FontWeight="Bold"
                                 Opacity="0.6"
                                 Cursor="Hand"
                                 VerticalContentAlignment="Center" HorizontalContentAlignment="Center">
                        <PathIcon Data="M3 3h7v7H3zM14 3h7v7h-7zM14 14h7v7h-7zM3 14h7v7H3z"
                                  Width="{Binding NavFontSize}" Height="{Binding NavFontSize}" />
                        <RadioButton.Template>
                            <ControlTemplate>
                                <Border Background="{TemplateBinding Background}" 
                                        CornerRadius="{Binding DataContext.NavCornerRadiusStruct, ElementName=Root}"
                                        Padding="{TemplateBinding Padding}">
                                    <ContentPresenter Content="{TemplateBinding Content}" 
                                                      HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                </Border>
                            </ControlTemplate>
                        </RadioButton.Template>
                         <RadioButton.Styles>
                            <Style Selector="RadioButton">
                                <Setter Property="Background" Value="Transparent"/>
                                <Setter Property="Transitions">
                                    <Transitions>
                                        <BrushTransition Property="Background" Duration="0:0:0.15"/>
                                        <BrushTransition Property="Foreground" Duration="0:0:0.15"/>
                                    </Transitions>
                                </Setter>
                            </Style>
                            <Style Selector="RadioButton:checked">
                                <Setter Property="Background" Value="{DynamicResource AccentBlueBrush}"/>
                                <Setter Property="Foreground" Value="White"/>
                                <Setter Property="Opacity" Value="1.0"/>
                            </Style>
                             <Style Selector="RadioButton:pointerover">
                                <Setter Property="Foreground" Value="White"/>
                                <Setter Property="Opacity" Value="0.9"/>
                            </Style>
                             <Style Selector="RadioButton:checked:pointerover">
                                <Setter Property="Foreground" Value="White"/>
                                <Setter Property="Opacity" Value="1.0"/>
                            </Style>
                        </RadioButton.Styles>
                    </RadioButton>
                    
                </StackPanel>
            </Border>
            
            <!-- MAIN CONTENT AREA -->
            <Grid Grid.Row="2" ClipToBounds="True">
                
                <!-- DASHBOARD TAB CONTENT -->
                <Grid IsVisible="{Binding IsDashboardTabSelected}" Margin="20,0,20,0">
                    <!-- StatsPanel - Full Height like Batch -->
                    <Border x:Name="Part_Stats" Classes="Card" Background="{DynamicResource CardBackgroundBrush}" 
                            CornerRadius="20" Padding="20"
                            VerticalAlignment="Stretch" HorizontalAlignment="Stretch"
                            BorderBrush="{DynamicResource CardBorderBrush}" BorderThickness="1">
                        <!-- Viewbox ensures the single-row grid shrinks to fit instead of clipping or wrapping -->
                        <Viewbox Stretch="Uniform" StretchDirection="DownOnly" VerticalAlignment="Center">
                            <Grid ColumnDefinitions="*,*,*,*" VerticalAlignment="Center">
                                <controls:StatWidget Grid.Column="0" Label="{Binding Language[Stats.Editing]}" Value="{Binding StatEditing}" Percentage="{Binding StatEditingPercentage}" 
                                                     Color="{Binding StatEditingColor}" ShowIcon="False"
                                                     AnimationDuration="{Binding StatAnimationDuration}"
                                                     Command="{Binding OpenEditingListCommand}"/>
                                                     
                                <controls:StatWidget Grid.Column="1" Label="{Binding Language[Stats.Revision]}" Value="{Binding StatRevision}" Percentage="{Binding StatRevisionPercentage}" 
                                                     Color="{Binding StatRevisionColor}" ShowIcon="False"
                                                     AnimationDuration="{Binding StatAnimationDuration}"
                                                     Command="{Binding OpenRevisionListCommand}"/>
                                                     
                                <controls:StatWidget Grid.Column="2" Label="{Binding Language[Stats.Late]}" Value="{Binding StatLate}" Percentage="{Binding StatLatePercentage}" 
                                                     Color="{Binding StatLateColor}" ShowIcon="False"
                                                     AnimationDuration="{Binding StatAnimationDuration}"
                                                     Command="{Binding OpenLateListCommand}"/>
                                                     
                                <controls:StatWidget Grid.Column="3" Label="{Binding Language[Stats.Points]}" Value="{Binding StatPoints}" Percentage="{Binding StatPointsPercentage}" 
                                                     Color="{Binding StatPointsColor}" ShowIcon="False"
                                                     AnimationDuration="{Binding StatAnimationDuration}"/>
                            </Grid>
                        </Viewbox>
                    </Border>
                </Grid>
                    
                    <!-- BATCH TAB CONTENT -->
                    <Grid IsVisible="{Binding IsBatchTabSelected}" RowDefinitions="*, Auto" Margin="20,0,20,0">
                        
                        <!-- DROP ZONE (Visible when no folders) -->
                        <Border Grid.Row="0" x:Name="BatchDropZone"
                                IsVisible="{Binding BatchVM.ShowDropZone}"
                                Background="{DynamicResource CardBackgroundBrush}" 
                                CornerRadius="20" Padding="40"
                                BorderBrush="{DynamicResource CardBorderBrush}" BorderThickness="2"
                                HorizontalAlignment="Stretch" VerticalAlignment="Stretch"
                                MinHeight="200"
                                DragDrop.AllowDrop="True">
                            <StackPanel Spacing="15" HorizontalAlignment="Center" VerticalAlignment="Center">
                                <shapes:Path Data="M19,13H13V19H11V13H5V11H11V5H13V11H19M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2Z" 
                                             Width="64" Height="64" Fill="{DynamicResource TextSecondaryBrush}" Stretch="Uniform" HorizontalAlignment="Center" Opacity="0.5"/>
                                <TextBlock Text="DRAG FOLDERS HERE" FontSize="16" FontWeight="Bold" 
                                           Foreground="{DynamicResource TextSecondaryBrush}" HorizontalAlignment="Center"/>
                                <TextBlock Text="Drop source folders to begin batch processing" FontSize="12" 
                                           Foreground="{DynamicResource TextSecondaryBrush}" HorizontalAlignment="Center" Opacity="0.7"/>
                            </StackPanel>
                        </Border>
                        
                        <!-- EXPLORER VIEW (Visible when folders exist) -->
                        <Grid Grid.Row="0" ColumnDefinitions="*,*" 
                              IsVisible="{Binding BatchVM.HasFolders}">
                            
                            <!-- SOURCE PANEL (Fieldset Style) -->
                            <Grid Grid.Column="0" Margin="0,0,5,0">
                                <Border Background="{DynamicResource CardBackgroundBrush}" 
                                        CornerRadius="20" Padding="15,10,15,15" Margin="0,8,0,0"
                                        BorderBrush="{DynamicResource CardBorderBrush}" BorderThickness="1">
                                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                                        <ItemsControl ItemsSource="{Binding BatchVM.SourceFolders}">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <StackPanel Margin="0,0,0,8">
                                                        <Grid ColumnDefinitions="*">
                                                            <!-- Folder Path (Clickable to Toggle) -->
                                                            <Button Grid.Column="0" Command="{Binding ToggleExpandedCommand, FallbackValue={x:Null}}" 
                                                                    Background="Transparent" BorderThickness="0" Padding="0"
                                                                    HorizontalAlignment="Left" Cursor="Hand"
                                                                    MinHeight="0" VerticalAlignment="Top">
                                                                <StackPanel Orientation="Horizontal" Spacing="8">
                                                                    <!-- Folder Icon/Name Only (No Checkbox) -->
                                                                    <TextBlock Text="{Binding DisplayName}" FontWeight="SemiBold" 
                                                                               Foreground="{DynamicResource TextPrimaryBrush}" FontSize="11" VerticalAlignment="Center"/>
                                                                </StackPanel>
                                                            </Button>
                                                        </Grid>
                                                        
                                                        <!-- Files List with Tree Line -->
                                                        <Border Margin="2,2,0,0" BorderBrush="{DynamicResource TextSecondaryBrush}" BorderThickness="0" Padding="4,0,0,0"
                                                                IsVisible="{Binding IsExpanded}">
                                                            <ItemsControl ItemsSource="{Binding SourceFiles}">
                                                                <ItemsControl.ItemTemplate>
                                                                    <DataTemplate>
                                                                        <Button Command="{Binding CopyPathCommand}" 
                                                                                Background="Transparent" BorderThickness="0" Padding="0,2" MinHeight="0"
                                                                                HorizontalAlignment="Stretch" HorizontalContentAlignment="Left"
                                                                                Cursor="Hand" ToolTip.Tip="{Binding FullPath}">
                                                                            <StackPanel Orientation="Horizontal" Spacing="8">
                                                                                <CheckBox IsChecked="{Binding IsSelected}" MinHeight="0" Padding="0"/>
                                                                                <TextBlock Text="{Binding FileName}" FontSize="11" 
                                                                                           Foreground="{DynamicResource TextSecondaryBrush}" VerticalAlignment="Center"/>
                                                                            </StackPanel>
                                                                        </Button>
                                                                    </DataTemplate>
                                                                </ItemsControl.ItemTemplate>
                                                            </ItemsControl>
                                                        </Border>
                                                    </StackPanel>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </ScrollViewer>
                                </Border>
                                <!-- Fieldset Label Overlap -->
                                <Border VerticalAlignment="Top" HorizontalAlignment="Left" Margin="20,0,0,0" 
                                        Background="{DynamicResource CardBackgroundBrush}" Padding="6,0" CornerRadius="4">
                                    <StackPanel Orientation="Horizontal" Spacing="4">
                                        <!-- Checkbox removed by user request -->
                                        <TextBlock Text="PILIHAN" FontWeight="Bold" FontSize="10" 
                                                   Foreground="{DynamicResource AccentBlueBrush}" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Border>
                            </Grid>
                            
                            <!-- OUTPUT PANEL (Fieldset Style) -->
                            <Grid Grid.Column="1" Margin="5,0,0,0">
                                <Border Background="{DynamicResource CardBackgroundBrush}" 
                                        CornerRadius="20" Padding="15,10,15,15" Margin="0,8,0,0"
                                        BorderBrush="{DynamicResource CardBorderBrush}" BorderThickness="1">
                                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                                        <ItemsControl ItemsSource="{Binding BatchVM.SourceFolders}"> <!-- Note: Using SourceFolders for layout demo, should bind correctly -->
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <StackPanel Margin="0,0,0,15">
                                                        <!-- Output Path -->
                                                        <StackPanel Orientation="Horizontal" Spacing="8" ToolTip.Tip="{Binding OutputPath}">
                                                            <TextBlock Text="{Binding OutputHeader}" FontWeight="SemiBold" 
                                                                       Foreground="{DynamicResource TextPrimaryBrush}" FontSize="11"/>
                                                            <TextBlock Text="(pending)" FontSize="11" 
                                                                       Foreground="{DynamicResource TextSecondaryBrush}"
                                                                       IsVisible="{Binding !OutputExists}"/>
                                                        </StackPanel>
                                                        <!-- Output Files List -->
                                                        <ItemsControl ItemsSource="{Binding OutputFiles}" Margin="6,5,0,0"
                                                                      IsVisible="{Binding OutputExists}">
                                                            <ItemsControl.ItemTemplate>
                                                                <DataTemplate>
                                                                        <Button Command="{Binding CopyPathCommand}" 
                                                                                Background="Transparent" BorderThickness="0" Padding="0,2" MinHeight="0"
                                                                                HorizontalAlignment="Stretch" HorizontalContentAlignment="Left"
                                                                                Cursor="Hand" ToolTip.Tip="{Binding FullPath}">
                                                                            <StackPanel Orientation="Horizontal" Spacing="8">
                                                                                <CheckBox IsChecked="{Binding IsSelected}" MinHeight="0" Padding="0"/>
                                                                                <TextBlock Text="{Binding FileName}" FontSize="11" 
                                                                                           Foreground="{DynamicResource TextSecondaryBrush}" VerticalAlignment="Center"/>
                                                                            </StackPanel>
                                                                        </Button>
                                                                </DataTemplate>
                                                            </ItemsControl.ItemTemplate>
                                                        </ItemsControl>
                                                    </StackPanel>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </ScrollViewer>
                                </Border>
                                <!-- Fieldset Label Overlap -->
                                <Border VerticalAlignment="Top" HorizontalAlignment="Right" Margin="0,0,20,0" 
                                        Background="{DynamicResource CardBackgroundBrush}" Padding="6,0" CornerRadius="4">
                                    <StackPanel Orientation="Horizontal" Spacing="4">
                                        <!-- Checkbox removed by user request -->
                                        <TextBlock Text="OUTPUT LOKAL" FontWeight="Bold" FontSize="10" 
                                                   Foreground="#FFFFFF" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Border>
                            </Grid>
                        </Grid>
                        
                        <!-- FOOTER -->
                        <Border Grid.Row="1" Margin="0,10,0,0" 
                                Background="{DynamicResource CardBackgroundBrush}" 
                                CornerRadius="12,12,0,0" Padding="15,10"
                                BorderBrush="{DynamicResource CardBorderBrush}" BorderThickness="1,1,1,0"
                                IsVisible="{Binding BatchVM.HasFolders}">
                                <!-- RESPONSIVE FOOTER PANEL -->
                                <Panel>
                                    <!-- Narrow Layout (Log Panel Open) -->
                                    <Grid x:Name="NarrowFooter" ColumnDefinitions="*, Auto" Margin="0"
                                          IsVisible="{Binding DataContext.IsLogPanelOpen, ElementName=Root}">
                                        
                                        <!-- Master Group -->
                                        <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="5" Margin="0,0,10,0" VerticalAlignment="Center">
                                            <StackPanel Spacing="2">
                                                <TextBlock Text="MASTER" FontSize="10" FontWeight="Bold" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                                <ComboBox ItemsSource="{Binding BatchVM.MasterScriptOptions}"
                                                          SelectedValue="{Binding BatchVM.SelectedMasterScript}"
                                                          DisplayMemberBinding="{Binding Name}"
                                                          SelectedValueBinding="{Binding Path}"
                                                          Width="150" Height="32"
                                                          PlaceholderText="Select Script..."
                                                          ToolTip.Tip="Select Python Script"/>
                                            </StackPanel>
                                            <Button Command="{Binding BatchVM.ExecuteMasterCommand}"
                                                    Background="{DynamicResource AccentGreenBrush}" Foreground="White"
                                                    CornerRadius="4" Width="40" Height="32" VerticalAlignment="Bottom"
                                                    ToolTip.Tip="Run Master">
                                                <shapes:Path Data="M8,5.14V19.14L19,12.14L8,5.14Z" 
                                                             Fill="White" Stretch="Uniform" Width="14" Height="14" Margin="2,0,0,0"/>
                                            </Button>

                                            <!-- Browse Template Button (Hidden as Auto-Path is implemented) -->
                                            <Button Command="{Binding BatchVM.BrowseMasterTemplateCommand}" 
                                                    IsVisible="False"
                                                    Width="32" Height="32" Padding="0" VerticalAlignment="Bottom"
                                                    Background="Transparent" BorderBrush="{DynamicResource CardBorderBrush}" BorderThickness="1"
                                                    CornerRadius="4" ToolTip.Tip="{Binding BatchVM.MasterTemplatePath, StringFormat='Template: {0}'}">
                                                <shapes:Path Data="M19,20H5C3.89,20 3,19.1 3,18V6C3,4.89 3.89,4 5,4H9L11,6H19C20.1,6 21,6.89 21,8V18C21,19.1 20.1,20 19,20Z" 
                                                             Fill="{DynamicResource TextSecondaryBrush}" Width="16" Height="16" Stretch="Uniform"/>
                                            </Button>
                                            
                                            <!-- Action Group -->
                                            <StackPanel Orientation="Horizontal" Spacing="5" Margin="20,0,0,0" VerticalAlignment="Center">
                                                <StackPanel Spacing="2">
                                                    <TextBlock Text="ACTION" FontSize="10" FontWeight="Bold" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                                    <ComboBox ItemsSource="{Binding BatchVM.ActionScriptOptions}"
                                                              SelectedValue="{Binding BatchVM.SelectedActionScript}"
                                                              DisplayMemberBinding="{Binding Name}"
                                                              SelectedValueBinding="{Binding Path}"
                                                              Width="150" Height="32"
                                                              PlaceholderText="Select Action..."
                                                              ToolTip.Tip="Select JSX Action"/>
                                                </StackPanel>
                                                <Button Command="{Binding BatchVM.ExecuteActionCommand}"
                                                        Background="{DynamicResource AccentGreenBrush}" Foreground="White"
                                                        CornerRadius="4" Width="40" Height="32" VerticalAlignment="Bottom"
                                                        ToolTip.Tip="Run Action">
                                                    <PathIcon Data="{StaticResource IconPlay}" Width="14" Height="14" Foreground="White" Margin="2,0,0,0"/>
                                                </Button>
                                            </StackPanel>
                                        </StackPanel>
                                        
                                        <!-- Refresh and Clear Buttons (Icons Only) -->
                                        <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="5" VerticalAlignment="Bottom" Margin="10,0,0,0">
                                            <!-- Scripts Path Button -->
                                            <Button Command="{Binding BatchVM.BrowseScriptsFolderCommand}" 
                                                    Width="32" Height="32" Padding="0"
                                                    Background="Transparent" BorderBrush="{DynamicResource CardBorderBrush}" BorderThickness="1"
                                                    CornerRadius="4" ToolTip.Tip="Set Scripts Folder">
                                                <shapes:Path Data="M10,4H4C2.89,4 2,4.89 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V8C22,6.89 21.1,6 20,6H12L10,4Z" 
                                                             Width="14" Height="14" Fill="{DynamicResource AccentBlueBrush}" Stretch="Uniform"/>
                                            </Button>
                                            
                                            <!-- Clear Button -->
                                            <Button Command="{Binding BatchVM.ClearCommand}" 
                                                    Width="32" Height="32" Padding="0"
                                                    Background="Transparent" BorderBrush="{DynamicResource CardBorderBrush}" BorderThickness="1"
                                                    CornerRadius="4" ToolTip.Tip="Clear All">
                                                <PathIcon Data="{StaticResource IconTrash}" Width="16" Height="16" Foreground="{DynamicResource AccentRedBrush}"/>
                                            </Button>
                                        </StackPanel>
                                    </Grid>

                                    <!-- Wide Layout (Log Panel Closed) -->
                                    <Grid x:Name="WideFooter" ColumnDefinitions="Auto, Auto, *, Auto, Auto" RowDefinitions="Auto" Margin="0"
                                          IsVisible="{Binding DataContext.IsLogPanelOpen, ElementName=Root, Converter={x:Static BoolConverters.Not}}">
                                        
                                        <!-- Master Group -->
                                        <StackPanel Grid.Row="0" Grid.Column="0" Orientation="Horizontal" Spacing="5" Margin="0,0,20,0" VerticalAlignment="Center">
                                            <StackPanel Spacing="2">
                                                <TextBlock Text="MASTER" FontSize="10" FontWeight="Bold" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                                <ComboBox ItemsSource="{Binding BatchVM.MasterScriptOptions}"
                                                          SelectedValue="{Binding BatchVM.SelectedMasterScript}"
                                                          DisplayMemberBinding="{Binding Name}"
                                                          SelectedValueBinding="{Binding Path}"
                                                          Width="150" Height="32" VerticalContentAlignment="Center"
                                                          MaxDropDownHeight="300"
                                                          PlaceholderText="Select Script..."
                                                          ToolTip.Tip="Select Python Script"/>
                                            </StackPanel>
                                            <Button Command="{Binding BatchVM.ExecuteMasterCommand}"
                                                    Background="{DynamicResource AccentGreenBrush}" Foreground="White"
                                                    CornerRadius="4" Width="40" Height="32" VerticalAlignment="Bottom"
                                                    ToolTip.Tip="Run Master">
                                                <shapes:Path Data="M8,5.14V19.14L19,12.14L8,5.14Z" 
                                                             Fill="White" Stretch="Uniform" Width="14" Height="14" Margin="2,0,0,0"/>
                                            </Button>
                                        </StackPanel>

                                        <!-- Action Group -->
                                        <StackPanel Grid.Row="0" Grid.Column="1" Orientation="Horizontal" Spacing="5" Margin="0" VerticalAlignment="Center">
                                            <StackPanel Spacing="2">
                                                <TextBlock Text="ACTION" FontSize="10" FontWeight="Bold" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                                <ComboBox ItemsSource="{Binding BatchVM.ActionScriptOptions}"
                                                          SelectedValue="{Binding BatchVM.SelectedActionScript}"
                                                          DisplayMemberBinding="{Binding Name}"
                                                          SelectedValueBinding="{Binding Path}"
                                                          Width="150" Height="32" VerticalContentAlignment="Center"
                                                          MaxDropDownHeight="300"
                                                          PlaceholderText="Select Action..."
                                                          ToolTip.Tip="Select JSX Action"/>
                                            </StackPanel>
                                            <Button Command="{Binding BatchVM.ExecuteActionCommand}"
                                                    Background="{DynamicResource AccentGreenBrush}" Foreground="White"
                                                    CornerRadius="4" Width="40" Height="32" VerticalAlignment="Bottom"
                                                    ToolTip.Tip="Run Action">
                                                <PathIcon Data="{StaticResource IconPlay}" Width="14" Height="14" Foreground="White" Margin="2,0,0,0"/>
                                            </Button>
                                        </StackPanel>

                                        <!-- Scripts Path Button -->
                                        <Button Grid.Row="0" Grid.Column="3" Command="{Binding BatchVM.BrowseScriptsFolderCommand}"
                                                Padding="0" Width="32" Height="32" VerticalAlignment="Bottom" HorizontalContentAlignment="Center" VerticalContentAlignment="Center"
                                                Background="Transparent" BorderBrush="{DynamicResource CardBorderBrush}" BorderThickness="1"
                                                CornerRadius="4" ToolTip.Tip="Set Scripts Folder"
                                                Margin="0,0,5,0">
                                             <shapes:Path Data="M10,4H4C2.89,4 2,4.89 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V8C22,6.89 21.1,6 20,6H12L10,4Z" 
                                                          Width="14" Height="14" Fill="{DynamicResource AccentBlueBrush}" Stretch="Uniform"/>
                                        </Button>

                                        <!-- Clear Button -->
                                        <Button Grid.Row="0" Grid.Column="4" Command="{Binding BatchVM.ClearCommand}"
                                                Padding="0" Width="90" Height="32" VerticalAlignment="Bottom" HorizontalContentAlignment="Center" VerticalContentAlignment="Center"
                                                Background="Transparent" BorderBrush="{DynamicResource CardBorderBrush}" BorderThickness="1"
                                                CornerRadius="4" ToolTip.Tip="Clear All" FontWeight="SemiBold" Foreground="{DynamicResource AccentRedBrush}">
                                            <StackPanel Orientation="Horizontal" Spacing="6">
                                                <PathIcon Data="{StaticResource IconTrash}" Width="14" Height="14"/>
                                                <TextBlock Text="Clear" VerticalAlignment="Center"/>
                                            </StackPanel>
                                        </Button>
                                    </Grid>
                                </Panel>
                        </Border>
                    </Grid>

                    <!-- LOCKER TAB CONTENT -->
                    <views:FolderLockerView DataContext="{Binding FolderLockerVM}" 
                                            IsVisible="{Binding DataContext.IsLockerTabSelected, ElementName=Root}" 
                                            Margin="20,0,20,0"/>
            </Grid>
        </Grid>
        
        <!-- LOG PANEL (Sidebar Column) -->
        <!-- Placed in Column 1 of the Root Grid, occupying full height (Row Span indefinite) -->
        <!-- GRID SPLITTER -->
        <GridSplitter Grid.Column="1" Width="4" HorizontalAlignment="Stretch" Background="Transparent" 
                      ResizeDirection="Columns" IsVisible="{Binding IsLogPanelOpen}"/>

        <!-- LOG PANEL (Sidebar Column) -->
        <!-- Placed in Column 2 of the Root Grid, occupying full height (Row Span indefinite) -->
        <views:LogPanelSidebar Grid.Column="2" Width="275" 
                               IsVisible="{Binding IsLogPanelOpen}" 
                               VerticalAlignment="Stretch"/>

        <!-- ACTIVITY PANEL (Overlay on right side of main content) -->
        <Border Grid.Column="0" HorizontalAlignment="Right" Width="320"
                Background="{DynamicResource CardBackgroundBrush}"
                BorderBrush="{DynamicResource CardBorderBrush}" BorderThickness="1,0,0,0"
                IsVisible="{Binding IsActivityPanelOpen}"
                BoxShadow="-4 0 20 0 #40000000">
            <Grid RowDefinitions="Auto, *, Auto" Margin="0">
                <!-- Header -->
                <Grid ColumnDefinitions="*, Auto" Margin="20,20,20,15">
                    <StackPanel Spacing="2">
                        <TextBlock Text="ACTIVITY LOG" FontSize="14" FontWeight="Bold" 
                                   Foreground="{DynamicResource TextPrimaryBrush}" LetterSpacing="1"/>
                        <TextBlock Text="Recent actions" FontSize="11" 
                                   Foreground="{DynamicResource TextSecondaryBrush}"/>
                    </StackPanel>
                    <Button Grid.Column="1" Command="{Binding CloseActivityPanelCommand}" 
                            Content="" Background="Transparent" BorderThickness="0" 
                            FontSize="16" Foreground="{DynamicResource TextSecondaryBrush}" Cursor="Hand"
                            VerticalAlignment="Top"/>
                </Grid>

                <!-- Activity List -->
                <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                    <ItemsControl ItemsSource="{Binding Activities}" Margin="20,0,20,20">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Grid ColumnDefinitions="Auto, *" Margin="0,0,0,15">
                                    <!-- Timeline Line -->
                                    <Border Grid.Column="0" Width="1" Background="{DynamicResource TextSecondaryBrush}" 
                                            HorizontalAlignment="Center" Margin="0,10,0,-15"
                                            IsVisible="{Binding !IsLast}" Opacity="0.3"/>
                                            
                                    <!-- Dot -->
                                    <Border Grid.Column="0" Width="8" Height="8" CornerRadius="4" 
                                            Background="{DynamicResource AccentBlueBrush}" Margin="0,6,12,0"
                                            VerticalAlignment="Top"/>
                                            
                                    <!-- Content -->
                                    <StackPanel Grid.Column="1" Spacing="2">
                                        <TextBlock Text="{Binding Title}" 
                                                   Foreground="{DynamicResource TextPrimaryBrush}" 
                                                   FontSize="13" FontWeight="SemiBold"
                                                   TextWrapping="Wrap"/>
                                                   
                                        <TextBlock Text="{Binding TimeDisplay}" 
                                                   Foreground="{DynamicResource TextSecondaryBrush}" 
                                                   FontSize="11"/>
                                    </StackPanel>
                                </Grid>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>

                <!-- Footer: Clear All Button -->
                <Border Grid.Row="2" BorderBrush="{DynamicResource CardBorderBrush}" BorderThickness="0,1,0,0" Padding="20,15">
                    <Button Command="{Binding ClearActivitiesCommand}" 
                            HorizontalAlignment="Stretch" HorizontalContentAlignment="Center"
                            Background="Transparent" BorderBrush="{DynamicResource AccentRedBrush}" BorderThickness="1"
                            Foreground="{DynamicResource AccentRedBrush}" CornerRadius="8" Padding="12,8" Cursor="Hand">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <PathIcon Data="{StaticResource IconTrash}" Width="14" Height="14"/>
                            <TextBlock Text="Clear All Activity" FontWeight="SemiBold"/>
                        </StackPanel>
                    </Button>
                </Border>
            </Grid>
        </Border>
    </Grid>
</UserControl>
