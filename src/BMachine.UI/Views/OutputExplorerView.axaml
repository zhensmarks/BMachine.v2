<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:BMachine.UI.ViewModels"
             xmlns:models="using:BMachine.UI.ViewModels"
             xmlns:services="using:BMachine.UI.Services"
             xmlns:converters="using:BMachine.UI.Converters"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
             x:Class="BMachine.UI.Views.OutputExplorerView"
             x:DataType="vm:OutputExplorerViewModel"
             x:Name="ExplorerRoot">

    <UserControl.Resources>
        <StreamGeometry x:Key="IconChevronRight">M9 18l6-6-6-6</StreamGeometry>
        <StreamGeometry x:Key="IconArrowUp">M12 19V5M5 12l7-7 7 7</StreamGeometry>
        <StreamGeometry x:Key="IconFolder">M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z</StreamGeometry>
        <StreamGeometry x:Key="IconFile">M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z M13 2v7h7</StreamGeometry>
        <StreamGeometry x:Key="IconArrowRight">M5 12h14M12 5l7 7-7 7</StreamGeometry>
        <StreamGeometry x:Key="IconCopy">M9 9h6v6H9z M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2</StreamGeometry>
        <StreamGeometry x:Key="IconRefresh">M23 4v6h-6 M1 20v-6h6 M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15</StreamGeometry>
        <StreamGeometry x:Key="IconCheck">M20 6L9 17l-5-5</StreamGeometry>
        <StreamGeometry x:Key="IconX">M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z</StreamGeometry>
        <StreamGeometry x:Key="IconTrash">M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2</StreamGeometry>
        
        <converters:EnumMatchConverter x:Key="EnumMatchConverter"/>

        <!-- BACKGROUND CONTEXT MENU (Shared) -->
    <ContextMenu x:Key="BackgroundMenu">
        <MenuItem Header="View">
            <MenuItem Header="List" 
                      ToggleType="Radio"
                      IsChecked="{Binding IsVerticalLayout, Mode=TwoWay}"/>
            <MenuItem Header="Grid" 
                      ToggleType="Radio"
                      IsChecked="{Binding IsHorizontalLayout, Mode=TwoWay}"/>
        </MenuItem>
        
        <MenuItem Header="Sort by">
            <MenuItem Header="Name" 
                      ToggleType="Radio"
                      IsChecked="{Binding SortBy, Converter={StaticResource EnumMatchConverter}, ConverterParameter=Name, Mode=TwoWay}"/>
            <MenuItem Header="Date" 
                      ToggleType="Radio"
                      IsChecked="{Binding SortBy, Converter={StaticResource EnumMatchConverter}, ConverterParameter=Date, Mode=TwoWay}"/>
            <Separator/>
            <MenuItem Header="Descending" 
                      ToggleType="CheckBox"
                      IsChecked="{Binding IsSortDescending, Mode=TwoWay}"/>
        </MenuItem>
        
        <MenuItem Header="Group by">
            <MenuItem Header="(None)" 
                      ToggleType="Radio"
                      IsChecked="{Binding GroupBy, Converter={StaticResource EnumMatchConverter}, ConverterParameter=None, Mode=TwoWay}"/>
            <MenuItem Header="Date" 
                      ToggleType="Radio"
                      IsChecked="{Binding GroupBy, Converter={StaticResource EnumMatchConverter}, ConverterParameter=Date, Mode=TwoWay}"/>
             <MenuItem Header="Type" 
                       ToggleType="Radio"
                       IsChecked="{Binding GroupBy, Converter={StaticResource EnumMatchConverter}, ConverterParameter=Type, Mode=TwoWay}"/>
        </MenuItem>
        
        <Separator/>
        
        <MenuItem Header="Refresh" Command="{Binding RefreshCommand}"/>
        
        <Separator/>
        <MenuItem Header="New Folder" Command="{Binding OpenNewFolderPopupCommand}"/>
        <MenuItem Header="New File (.txt)" Command="{Binding OpenNewFilePopupCommand}"/>
        <Separator/>
        <MenuItem Header="Master Browser Sync" Command="{Binding CopyMasterBrowserHereCommand}"/>
        <MenuItem Header="New Explorer Window" Command="{Binding NewExplorerWindowCommand}"/>
        <Separator/>
        
        <MenuItem Header="This Folder Only" 
                  ToggleType="CheckBox"
                  IsChecked="{Binding IsLocalSettings, Mode=TwoWay}"/>
        
        <!-- Toggle Show Path -->
        <MenuItem Header="Show Path Bar" 
                  ToggleType="CheckBox"
                  IsChecked="{Binding IsShowPathBar, Mode=TwoWay}"/>
    </ContextMenu>
    </UserControl.Resources>


    <Grid>
        <Grid.RowDefinitions>
             <RowDefinition Height="*"/> <!-- Row 0: Explorer Main Area (Fills space) -->
             <RowDefinition Height="{Binding TaskMonitorHeight, Mode=TwoWay}"/> <!-- Row 1: Task Monitor -->
        </Grid.RowDefinitions>

        <!-- TOP: EXPLORER MAIN AREA -->
        <Grid Grid.Row="0">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/> <!-- Header (Breadcrumbs) -->
                <RowDefinition Height="*"/>    <!-- Main Content (Sidebar | Splitter | Files) -->
            </Grid.RowDefinitions>

            <!-- 1. HEADER: Navigation & Breadcrumbs (Full Width) -->
            <Border Grid.Row="0" Padding="8,4" Background="{DynamicResource CardBackgroundBrush}" BorderBrush="{DynamicResource SeparatorBrush}" BorderThickness="0,0,0,1" IsVisible="{Binding IsShowPathBar}">
                <Grid ColumnDefinitions="Auto, *">
                    <!-- Left: Navigation -->
                    <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="2" VerticalAlignment="Center">
                        <Button Command="{Binding GoBackCommand}" IsEnabled="{Binding CanGoBack}" Classes="Clear" ToolTip.Tip="Back (Backspace)" Padding="4">
                             <PathIcon Data="{StaticResource IconChevronRight}" Width="12" Height="12" RenderTransform="rotate(180deg)"/>
                        </Button>
                        <Button Command="{Binding GoForwardCommand}" IsEnabled="{Binding CanGoForward}" Classes="Clear" ToolTip.Tip="Forward" Padding="4">
                             <PathIcon Data="{StaticResource IconChevronRight}" Width="12" Height="12"/>
                        </Button>
                        <Rectangle Width="1" Height="16" Fill="{DynamicResource SeparatorBrush}" Margin="4,0"/>
                        <Button Command="{Binding RefreshCommand}" Classes="Clear" ToolTip.Tip="Refresh" Padding="4">
                             <PathIcon Data="{StaticResource IconRefresh}" Width="12" Height="12"/>
                        </Button>
                    </StackPanel>
                    
                    <!-- Center: Breadcrumbs -->
                    <ScrollViewer Grid.Column="1" HorizontalScrollBarVisibility="Hidden" VerticalScrollBarVisibility="Disabled" Margin="5,0">
                         <ItemsControl ItemsSource="{Binding Breadcrumbs}">
                             <ItemsControl.ItemsPanel>
                                 <ItemsPanelTemplate>
                                     <StackPanel Orientation="Horizontal" Spacing="2"/>
                                 </ItemsPanelTemplate>
                             </ItemsControl.ItemsPanel>
                             <ItemsControl.ItemTemplate>
                                 <DataTemplate>
                                     <StackPanel Orientation="Horizontal" Spacing="2" VerticalAlignment="Center">
                                          <TextBlock Text="{Binding Name}" FontWeight="SemiBold" FontSize="11" VerticalAlignment="Center" Foreground="{DynamicResource TextPrimaryBrush}"/>
                                          <PathIcon Data="{StaticResource IconChevronRight}" Width="8" Height="8" Foreground="{DynamicResource TextSecondaryBrush}" VerticalAlignment="Center"/>
                                     </StackPanel>
                                 </DataTemplate>
                             </ItemsControl.ItemTemplate>
                         </ItemsControl>
                    </ScrollViewer>
                </Grid>
            </Border>


            <!-- 2. Main Content (Sidebar | Splitter | Files) -->
            <Grid Grid.Row="1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="{Binding SidebarWidth, Mode=TwoWay}" MinWidth="32" MaxWidth="400"/>
                    <ColumnDefinition Width="2"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- SIDEBAR (LEFT) -->
                <Grid Grid.Column="0">
                    <Grid RowDefinitions="*, Auto" Margin="0,4,0,0">
                         <!-- Sidebar Items List -->
                         <ListBox Grid.Row="0" ItemsSource="{Binding QuickAccessItems}" Background="Transparent" BorderThickness="0" Padding="0">
                             <ListBox.ItemTemplate>
                                 <DataTemplate x:DataType="models:SidebarItemViewModel">
                                      <Grid ColumnDefinitions="Auto, *" Background="Transparent" Height="24" ToolTip.Tip="{Binding Path}">
                                          <Grid.ContextMenu>
                                              <ContextMenu>
                                                  <MenuItem Header="Remove Pin" Command="{Binding #ExplorerRoot.DataContext.RemoveFromQuickAccessCommand}" CommandParameter="{Binding}"/>
                                              </ContextMenu>
                                          </Grid.ContextMenu>
                                          <Interaction.Behaviors>
                                              <EventTriggerBehavior EventName="PointerPressed">
                                                  <InvokeCommandAction Command="{Binding #ExplorerRoot.DataContext.NavigateToQuickAccessCommand}" CommandParameter="{Binding}"/>
                                              </EventTriggerBehavior>
                                          </Interaction.Behaviors>
                                          
                                          <PathIcon Grid.Column="0" Data="{StaticResource IconFolder}" Width="12" Height="12" Margin="8,0" Foreground="{DynamicResource AccentBlueBrush}"/>
                                          <TextBlock Grid.Column="1" Text="{Binding Name}" VerticalAlignment="Center" FontSize="11" Foreground="{DynamicResource TextPrimaryBrush}" TextTrimming="CharacterEllipsis"/>
                                      </Grid>
                                 </DataTemplate>
                             </ListBox.ItemTemplate>
                             <ListBox.Styles>
                                 <Style Selector="ListBoxItem">
                                     <Setter Property="Padding" Value="0"/>
                                     <Setter Property="Margin" Value="4,0"/>
                                     <Setter Property="CornerRadius" Value="4"/>
                                 </Style>
                             </ListBox.Styles>
                         </ListBox>
                         
                         <!-- Add Button Moved to Bottom -->
                         <Button Grid.Row="1" Command="{Binding AddExternalFolderCommand}" 
                                 Padding="6" Background="Transparent" BorderThickness="0" Cursor="Hand" ToolTip.Tip="Pin External Folder" HorizontalAlignment="Center" Margin="0,4">
                             <PathIcon Data="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" Width="12" Height="12" Foreground="{DynamicResource TextPrimaryBrush}"/>
                         </Button>
                    </Grid>
                    
                    <!-- Vertical Separator Decor -->
                    <Border HorizontalAlignment="Right" Width="1" Background="{DynamicResource SeparatorBrush}" Opacity="0.5" Margin="0,10"/>
                </Grid>
                
                <!-- SPLITTER -->
                <GridSplitter Grid.Column="1" Background="{DynamicResource SeparatorBrush}" ResizeDirection="Columns" Opacity="0.5"/>
                
                <!-- MAIN CONTENT (RIGHT) - FILES LIST -->
                <Grid Grid.Column="2">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    
                    
                    <!-- ListBox RESTORED -->
                    <Grid Grid.Row="0">
                        <!-- Empty State -->
                        <Grid>
                             <!-- 1. Normal Empty -->
                             <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center" Spacing="10" 
                                         IsVisible="{Binding IsEmpty}">
                                  <PathIcon Data="{StaticResource IconFolder}" Width="40" Height="40" Foreground="{DynamicResource TextSecondaryBrush}" Opacity="0.5"/>
                                  <TextBlock Text="Folder kosong." Foreground="{DynamicResource TextSecondaryBrush}" 
                                         IsVisible="{Binding !IsRootPathMissing}" HorizontalAlignment="Center"/>
                                  
                             </StackPanel>
                             
                             <!-- 2. Config Missing -->
                             <StackPanel Spacing="5" IsVisible="{Binding IsRootPathMissing}" HorizontalAlignment="Center" VerticalAlignment="Center">
                                  <TextBlock Text="Local Output belum disetting." Foreground="{DynamicResource TextSecondaryBrush}" HorizontalAlignment="Center"/>
                                  <TextBlock Text="Silahkan atur di menu Settings > Paths" Foreground="{DynamicResource AccentBrush}" FontSize="12" HorizontalAlignment="Center" Cursor="Hand"/>
                             </StackPanel>
                        </Grid>
                    </Grid>


                    <!-- VERTICAL LIST VIEW (Standard) -->
                    <ListBox ItemsSource="{Binding Items}" 
                             SelectedItems="{Binding SelectedItems}"
                             SelectionMode="Multiple"
                             Background="{DynamicResource AppBackgroundBrush}" 
                             IsVisible="{Binding IsVerticalLayoutAndNotEmpty}" 
                             ClipToBounds="True"
                             ContextMenu="{StaticResource BackgroundMenu}">
                        <ListBox.KeyBindings>
                            <KeyBinding Gesture="Back" Command="{Binding GoBackCommand}"/>
                        </ListBox.KeyBindings>
                        <ListBox.Styles>
                            <Style Selector="ListBoxItem">
                                <Setter Property="Padding" Value="4,0"/>
                                <Setter Property="Margin" Value="0,1"/>
                                <Setter Property="MinHeight" Value="28"/>
                                <Setter Property="VerticalContentAlignment" Value="Center"/>
                            </Style>
                        </ListBox.Styles>
                        <ListBox.DataTemplates>
                            <!-- HEADER TEMPLATE -->
                            <DataTemplate x:DataType="vm:ExplorerGroupHeaderViewModel">
                                 <Border Padding="10,5,0,2" Margin="0,10,0,5" Background="Transparent">
                                     <TextBlock Text="{Binding Title}" FontWeight="Bold" Foreground="{DynamicResource TextPrimaryBrush}" FontSize="12" Opacity="0.8"/>
                                 </Border>
                            </DataTemplate>
                            
                            <!-- ITEM TEMPLATE -->
                            <DataTemplate x:DataType="vm:ExplorerItemViewModel">
                                 <Grid ColumnDefinitions="Auto, *" Background="Transparent" Height="28" DoubleTapped="OnItemDoubleTapped">
                                      <Grid.ContextMenu>
                                          <ContextMenu>
                                              <!-- Top Row Buttons -->
                                              <MenuItem Header="{x:Null}">
                                                  <MenuItem.Template>
                                                      <ControlTemplate>
                                                          <StackPanel Orientation="Horizontal" Spacing="5" Margin="4,2">
                                                              <Button Content="COPY to #OKE" Command="{Binding #ExplorerRoot.DataContext.CopyToOkeCommand}" CommandParameter="{Binding}" Classes="ContextMenuAction"/>
                                                              <Button Content="MOVE to #OKE" Command="{Binding #ExplorerRoot.DataContext.MoveToOkeCommand}" CommandParameter="{Binding}" Classes="ContextMenuAction"/>
                                                          </StackPanel>
                                                      </ControlTemplate>
                                                  </MenuItem.Template>
                                              </MenuItem>
                                              <Separator/>
                                              
                                              <!-- Batch Submenu -->
                                              <MenuItem Header="Batch" Classes="ForceChevron" ItemsSource="{Binding #ExplorerRoot.DataContext.ScriptOptions}">
                                                  <MenuItem.Styles>
                                                      <Style Selector="MenuItem">
                                                          <Setter Property="Header" Value="{Binding Name}"/>
                                                          <Setter Property="Command" Value="{Binding #ExplorerRoot.DataContext.BatchScriptCommand}"/>
                                                          <Setter Property="CommandParameter" Value="{Binding}"/>
                                                      </Style>
                                                  </MenuItem.Styles>
                                              </MenuItem>
                                              
                                              <MenuItem Header="Pin to Sidebar" Command="{Binding #ExplorerRoot.DataContext.AddToQuickAccessCommand}" CommandParameter="{Binding}"/>
                                              <MenuItem Header="Rename" Command="{Binding #ExplorerRoot.DataContext.RenameItemCommand}" CommandParameter="{Binding}" InputGesture="F2"/>
                                              <MenuItem Header="Batch Rename (From Clipboard)" Command="{Binding #ExplorerRoot.DataContext.BatchRenameFromClipboardCommand}"/>
                                              <MenuItem Header="Copy Full Path" Command="{Binding #ExplorerRoot.DataContext.CopyPathCommand}" CommandParameter="{Binding}"/>
                                              <MenuItem Header="Copy Name Only" Command="{Binding #ExplorerRoot.DataContext.CopyNameCommand}" CommandParameter="{Binding}"/>
                                              
                                              <Separator/>
                                              <MenuItem Header="{Binding #ExplorerRoot.DataContext.ShowInExplorerHeader}" Command="{Binding #ExplorerRoot.DataContext.ShowInExplorerCommand}" CommandParameter="{Binding}"/>
                                              
                                              <Separator/>
                                              <MenuItem Header="Duplicate..." Command="{Binding #ExplorerRoot.DataContext.OpenDuplicatePopupCommand}"/>
                                               <!-- Note: OpenDuplicatePopupCommand is global, might need parameter if we want to dupe specific item. 
                                                    Currently DuplicateItem iterates Selection. Selection updates on RightClick usually. -->

                                              <MenuItem Header="Delete" Command="{Binding #ExplorerRoot.DataContext.DeleteItemCommand}" CommandParameter="{Binding}" Foreground="#FF453A"/>
                                          </ContextMenu>
                                      </Grid.ContextMenu>
                                      <PathIcon Grid.Column="0" Data="{StaticResource IconFolder}" IsVisible="{Binding IsDirectory}" Width="16" Height="16" Margin="8,0" Foreground="#6f7c94"/>
                                      <PathIcon Grid.Column="0" Data="{StaticResource IconFile}" IsVisible="{Binding !IsDirectory}" Width="14" Height="14" Margin="9,0" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                      <TextBlock Grid.Column="1" Text="{Binding Name}" FontSize="12" VerticalAlignment="Center" FontWeight="Medium" TextTrimming="CharacterEllipsis"/>
                                 </Grid>
                            </DataTemplate>
                        </ListBox.DataTemplates>
                    </ListBox>
                    

                    <!-- HORIZONTAL LIST VIEW (Columnar/Right Scroll) -->
                    <ListBox ItemsSource="{Binding Items}" 
                             SelectedItems="{Binding SelectedItems}"
                             SelectionMode="Multiple"
                             Background="{DynamicResource AppBackgroundBrush}" 
                             IsVisible="{Binding IsHorizontalLayoutAndNotEmpty}" 
                             ClipToBounds="True"
                             ScrollViewer.VerticalScrollBarVisibility="Disabled"
                             ScrollViewer.HorizontalScrollBarVisibility="Auto"
                             PointerWheelChanged="OnHorizontalListPointerWheelChanged"
                             ContextMenu="{StaticResource BackgroundMenu}">
                        <ListBox.KeyBindings>
                            <KeyBinding Gesture="Back" Command="{Binding GoBackCommand}"/>
                        </ListBox.KeyBindings>
                        <ListBox.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel Orientation="Vertical" />
                            </ItemsPanelTemplate>
                        </ListBox.ItemsPanel>
                        <ListBox.Styles>
                             <Style Selector="ListBoxItem">
                                <Setter Property="Padding" Value="4,0"/>
                                <Setter Property="Margin" Value="0,1"/>
                                <Setter Property="VerticalContentAlignment" Value="Center"/>
                                <Setter Property="Background" Value="Transparent"/>
                                
                                <Setter Property="IsHitTestVisible" Value="{Binding IsSelectable, FallbackValue=True}"/>
                                <Setter Property="Focusable" Value="{Binding IsSelectable, FallbackValue=True}"/>
                            </Style>
                        </ListBox.Styles>
                        <ListBox.DataTemplates>
                            <!-- HEADER TEMPLATE -->
                            <DataTemplate x:DataType="vm:ExplorerGroupHeaderViewModel">
                                 <!-- Header: Invisible Column Break (Transparent Separator) -->
                                 <Border Width="2" 
                                         Height="{Binding $parent[ListBox].Bounds.Height}" 
                                         Margin="0,0,8,0"
                                         VerticalAlignment="Stretch"
                                         Background="Transparent"
                                         BorderThickness="0,0,2,0"
                                         BorderBrush="Transparent"
                                         IsHitTestVisible="False"
                                         Focusable="False"/>
                            </DataTemplate>

                            <DataTemplate x:DataType="vm:ExplorerItemViewModel">
                                <!-- Item: Fixed Size Card (Compact) -->
                                 <Grid Width="130" MinHeight="20" ColumnDefinitions="Auto, *" Background="Transparent" DoubleTapped="OnItemDoubleTapped" ToolTip.Tip="{Binding Name}">
                                       <Grid.ContextMenu>
                                          <ContextMenu>
                                              <!-- Top Row Buttons -->
                                              <MenuItem Header="{x:Null}">
                                                  <MenuItem.Template>
                                                      <ControlTemplate>
                                                          <StackPanel Orientation="Horizontal" Spacing="5" Margin="4,2">
                                                              <Button Content="COPY to #OKE" Command="{Binding #ExplorerRoot.DataContext.CopyToOkeCommand}" CommandParameter="{Binding}" Classes="ContextMenuAction"/>
                                                              <Button Content="MOVE to #OKE" Command="{Binding #ExplorerRoot.DataContext.MoveToOkeCommand}" CommandParameter="{Binding}" Classes="ContextMenuAction"/>
                                                          </StackPanel>
                                                      </ControlTemplate>
                                                  </MenuItem.Template>
                                              </MenuItem>
                                              <Separator/>
                                              
                                              <!-- Batch Submenu -->
                                              <MenuItem Header="Batch" Classes="ForceChevron" ItemsSource="{Binding #ExplorerRoot.DataContext.ScriptOptions}">
                                                  <MenuItem.Styles>
                                                      <Style Selector="MenuItem">
                                                          <Setter Property="Header" Value="{Binding Name}"/>
                                                          <Setter Property="Command" Value="{Binding #ExplorerRoot.DataContext.BatchScriptCommand}"/>
                                                          <Setter Property="CommandParameter" Value="{Binding}"/>
                                                      </Style>
                                                  </MenuItem.Styles>
                                              </MenuItem>
                                              
                                              <MenuItem Header="Pin to Sidebar" Command="{Binding #ExplorerRoot.DataContext.AddToQuickAccessCommand}" CommandParameter="{Binding}"/>
                                              <MenuItem Header="Rename" Command="{Binding #ExplorerRoot.DataContext.RenameItemCommand}" CommandParameter="{Binding}" InputGesture="F2"/>
                                              <MenuItem Header="Batch Rename (From Clipboard)" Command="{Binding #ExplorerRoot.DataContext.BatchRenameFromClipboardCommand}"/>
                                              <MenuItem Header="Copy Full Path" Command="{Binding #ExplorerRoot.DataContext.CopyPathCommand}" CommandParameter="{Binding}"/>
                                              <MenuItem Header="Copy Name Only" Command="{Binding #ExplorerRoot.DataContext.CopyNameCommand}" CommandParameter="{Binding}"/>
                                              
                                              <Separator/>
                                              <MenuItem Header="{Binding #ExplorerRoot.DataContext.ShowInExplorerHeader}" Command="{Binding #ExplorerRoot.DataContext.ShowInExplorerCommand}" CommandParameter="{Binding}"/>
                                              
                                              <Separator/>
                                              <MenuItem Header="Duplicate..." Command="{Binding #ExplorerRoot.DataContext.OpenDuplicatePopupCommand}"/>

                                              <MenuItem Header="Delete" Command="{Binding #ExplorerRoot.DataContext.DeleteItemCommand}" CommandParameter="{Binding}" Foreground="#FF453A"/>
                                          </ContextMenu>
                                       </Grid.ContextMenu>
                                       <PathIcon Grid.Column="0" Data="{StaticResource IconFolder}" IsVisible="{Binding IsDirectory}" Width="14" Height="14" Margin="6,0" Foreground="#6f7c94"/>
                                       <PathIcon Grid.Column="0" Data="{StaticResource IconFile}" IsVisible="{Binding !IsDirectory}" Width="12" Height="12" Margin="7,0" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                       <TextBlock Grid.Column="1" Text="{Binding Name}" FontSize="11" VerticalAlignment="Center" FontWeight="Medium" TextTrimming="CharacterEllipsis"/>
                                 </Grid>
                            </DataTemplate>
                        </ListBox.DataTemplates>
                    </ListBox>
                </Grid>
            </Grid>
        </Grid>

        <GridSplitter Grid.Row="1" Background="{DynamicResource SeparatorBrush}" ResizeDirection="Rows"/>
        
        <!-- Task Monitor Section -->
        <Border Grid.Row="2" Background="{DynamicResource CardBackgroundBrush}" BorderBrush="{DynamicResource SeparatorBrush}" BorderThickness="0,1,0,0">
            <Grid RowDefinitions="Auto, *">
                <Border Grid.Row="0" Padding="10,5" Background="{DynamicResource AppBackgroundBrush}">
                    <Grid ColumnDefinitions="Auto, *, Auto">
                        <!-- Left: Label -->
                        <TextBlock Grid.Column="0" Text="TASK MONITOR" FontWeight="Bold" FontSize="11" Foreground="{DynamicResource TextSecondaryBrush}" VerticalAlignment="Center"/>
                        
                        <!-- Center: Badge -->
                        <Border Grid.Column="1" Background="{DynamicResource AccentBrush}" CornerRadius="10" Padding="8,2" HorizontalAlignment="Center" IsVisible="{Binding ActiveTasks.Count}">
                            <TextBlock Text="{Binding ActiveTasks.Count, StringFormat='{}{0} Active'}" FontSize="10" Foreground="White" FontWeight="SemiBold"/>
                        </Border>
                        
                        <!-- Right: Clear Button -->
                        <Button Grid.Column="2" Classes="Clear" Command="{Binding ClearCompletedCommand}" ToolTip.Tip="Clear Completed">
                            <StackPanel Orientation="Horizontal" Spacing="4">
                                <PathIcon Data="{StaticResource IconTrash}" Width="12" Height="12"/>
                                <TextBlock Text="Clear" FontSize="10" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                    </Grid>
                </Border>
                
                <ScrollViewer Grid.Row="1">
                    <ItemsControl ItemsSource="{Binding ActiveTasks}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate x:DataType="services:FileTaskItem">
                                <Border Padding="10" BorderBrush="{DynamicResource SeparatorBrush}" BorderThickness="0,0,0,1">
                                    <Grid ColumnDefinitions="40, *, Auto, 40">
                                        <!-- Status Icon -->
                                        <PathIcon Grid.Column="0" Data="{StaticResource IconRefresh}" IsVisible="{Binding !IsCompleted}" Classes="Spin" Width="16" Height="16"/>
                                        <PathIcon Grid.Column="0" Data="{StaticResource IconCheck}" IsVisible="{Binding IsCompleted}" Foreground="Green" Width="16" Height="16"/>
                                        <PathIcon Grid.Column="0" Data="{StaticResource IconX}" IsVisible="{Binding IsCancelled}" Foreground="Red" Width="16" Height="16"/>
                                        
                                        <!-- Progress & Details -->
                                        <StackPanel Grid.Column="1" Spacing="4" Margin="0,0,10,0">
                                            <Grid ColumnDefinitions="*, Auto">
                                                <TextBlock Text="{Binding Name}" FontWeight="Bold" TextTrimming="CharacterEllipsis"/>
                                                <TextBlock Grid.Column="1" Text="{Binding Status}" Foreground="{DynamicResource TextSecondaryBrush}" FontSize="11" Margin="5,0,0,0"/>
                                            </Grid>
                                            
                                            <!-- Path Visual -->
                                            <TextBlock FontSize="10" Foreground="{DynamicResource TextSecondaryBrush}" TextTrimming="CharacterEllipsis">
                                                <Run Text="{Binding SourcePath}"/>
                                                <Run Text=" âžœ " Foreground="{DynamicResource AccentBrush}" FontWeight="Bold"/>
                                                <Run Text="{Binding DestinationPath}"/>
                                            </TextBlock>
                                            
                                            <ProgressBar Value="{Binding Progress}" Maximum="100" Height="4" IsIndeterminate="{Binding Status, Converter={x:Static converters:StringEqualsConverter.Instance}, ConverterParameter='Running...'}"/>
                                        </StackPanel>
                                        
                                        <!-- Percentage -->
                                        <TextBlock Grid.Column="2" Text="{Binding Progress, StringFormat='{}{0:0}%'}" VerticalAlignment="Center" HorizontalAlignment="Right" FontWeight="Bold" Margin="0,0,10,0" MinWidth="40" TextAlignment="Right"/>

                                        <!-- Stop Button -->
                                        <Button Grid.Column="3" Classes="Clear" 
                                                Command="{Binding #ExplorerRoot.DataContext.CancelTaskCommand}" 
                                                CommandParameter="{Binding}"
                                                IsVisible="{Binding !IsCompleted}"
                                                ToolTip.Tip="Cancel Task"
                                                HorizontalAlignment="Center"
                                                VerticalAlignment="Center">
                                            <PathIcon Data="{StaticResource IconX}" Width="12" Height="12" Foreground="Red"/>
                                        </Button>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Grid>
        </Border>

        <!-- FLYOUT OVERLAYS (Z-Index Top) -->
        <Grid Grid.Row="0" Grid.RowSpan="3" Background="#80000000" IsVisible="{Binding IsNewFolderVisible}">
            <Border Background="{DynamicResource CardBackgroundBrush}" BorderBrush="{DynamicResource SeparatorBrush}" BorderThickness="1" CornerRadius="8" HorizontalAlignment="Center" VerticalAlignment="Center" Padding="20" MinWidth="300" BoxShadow="0 4 10 0 #40000000">
                <StackPanel Spacing="15">
                    <TextBlock Text="New Folder" FontWeight="Bold" FontSize="16"/>
                    <TextBox Text="{Binding NewItemName}" Watermark="Folder Name">
                        <TextBox.KeyBindings>
                            <KeyBinding Gesture="Enter" Command="{Binding ConfirmNewFolderCommand}"/>
                            <KeyBinding Gesture="Escape" Command="{Binding ClosePopupsCommand}"/>
                        </TextBox.KeyBindings>
                    </TextBox>
                    <StackPanel Orientation="Horizontal" Spacing="10" HorizontalAlignment="Right">
                        <Button Content="Cancel" Command="{Binding ClosePopupsCommand}" Classes="Secondary"/>
                        <Button Content="Create" Command="{Binding ConfirmNewFolderCommand}" Classes="Accent"/>
                    </StackPanel>
                </StackPanel>
            </Border>
        </Grid>

        <Grid Grid.Row="0" Grid.RowSpan="3" Background="#80000000" IsVisible="{Binding IsNewFileVisible}">
            <Border Background="{DynamicResource CardBackgroundBrush}" BorderBrush="{DynamicResource SeparatorBrush}" BorderThickness="1" CornerRadius="8" HorizontalAlignment="Center" VerticalAlignment="Center" Padding="20" MinWidth="300" BoxShadow="0 4 10 0 #40000000">
                <StackPanel Spacing="15">
                    <TextBlock Text="New File" FontWeight="Bold" FontSize="16"/>
                    <TextBox Text="{Binding NewItemName}" Watermark="File Name (e.g. notes.txt)">
                        <TextBox.KeyBindings>
                            <KeyBinding Gesture="Enter" Command="{Binding ConfirmNewFileCommand}"/>
                            <KeyBinding Gesture="Escape" Command="{Binding ClosePopupsCommand}"/>
                        </TextBox.KeyBindings>
                    </TextBox>
                    <StackPanel Orientation="Horizontal" Spacing="10" HorizontalAlignment="Right">
                        <Button Content="Cancel" Command="{Binding ClosePopupsCommand}" Classes="Secondary"/>
                        <Button Content="Create" Command="{Binding ConfirmNewFileCommand}" Classes="Accent"/>
                    </StackPanel>
                </StackPanel>
            </Border>
        </Grid>
        
        <Grid Grid.Row="0" Grid.RowSpan="3" Background="#80000000" IsVisible="{Binding IsDuplicateVisible}">
            <Border Background="{DynamicResource CardBackgroundBrush}" BorderBrush="{DynamicResource SeparatorBrush}" BorderThickness="1" CornerRadius="8" HorizontalAlignment="Center" VerticalAlignment="Center" Padding="20" MinWidth="300" BoxShadow="0 4 10 0 #40000000">
                <StackPanel Spacing="15">
                    <TextBlock Text="Duplicate Items" FontWeight="Bold" FontSize="16"/>
                     <StackPanel Orientation="Horizontal" Spacing="10">
                        <TextBlock Text="Quantity:" VerticalAlignment="Center"/>
                        <NumericUpDown Value="{Binding DuplicateCount}" Minimum="1" Maximum="100" Width="100"/>
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Spacing="10" HorizontalAlignment="Right">
                        <Button Content="Cancel" Command="{Binding ClosePopupsCommand}" Classes="Secondary"/>
                        <Button Content="Duplicate" Command="{Binding ConfirmDuplicateCommand}" Classes="Accent"/>
                    </StackPanel>
                </StackPanel>
            </Border>
        </Grid>

    </Grid>
</UserControl>
