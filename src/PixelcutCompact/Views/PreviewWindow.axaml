<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:views="using:PixelcutCompact.Views"
        mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="600"
        x:Class="PixelcutCompact.Views.PreviewWindow"
        Title="Preview"
        WindowStartupLocation="CenterOwner"
        Width="1000" Height="600"
        SystemDecorations="Full"
        ExtendClientAreaToDecorationsHint="True"
        ExtendClientAreaChromeHints="NoChrome"
        ExtendClientAreaTitleBarHeightHint="-1"
        Background="Transparent"
        TransparencyLevelHint="AcrylicBlur"
        Focusable="True"
        KeyDown="OnPreviewKeyDown">

    <Border Background="{DynamicResource CardBackgroundBrush}" CornerRadius="10" BorderBrush="#33000000" BorderThickness="1" ClipToBounds="True">
        <Grid RowDefinitions="Auto, *">
            <!-- Header (Draggable) -->
            <Grid Grid.Row="0" Background="Transparent" ColumnDefinitions="*, Auto, *" MinHeight="50">
                 <!-- Left: Title & Photoshop (Draggable) -->
                 <StackPanel Grid.Column="0" Orientation="Vertical" VerticalAlignment="Center" Spacing="4" Margin="15,10,0,10" PointerPressed="OnHeaderPointerPressed" Background="Transparent">
                     <TextBlock x:Name="TxtTitle" Text="Preview Before/After" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}" TextTrimming="CharacterEllipsis"/>
                     
                     <!-- Photoshop Button -->
                     <Button Click="OnPhotoshopClick" HorizontalAlignment="Left" Padding="12,6" Background="{DynamicResource AccentBlueBrush}" CornerRadius="4" BorderThickness="0" ToolTip.Tip="Open in Photoshop for editing">
                         <TextBlock Text="PHOTOSHOP" FontSize="11" FontWeight="Bold" Foreground="White" VerticalAlignment="Center"/>
                     </Button>
                 </StackPanel>

                 <!-- Center: Navigation (NO PointerPressed to allow button clicks) -->
                 <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="15" VerticalAlignment="Center" HorizontalAlignment="Center">
                     <Button Click="OnPreviousClick" Width="32" Height="32" CornerRadius="16" Background="#20FFFFFF" BorderThickness="1" BorderBrush="#40FFFFFF" ToolTip.Tip="Previous">
                         <PathIcon Data="M15.41,16.58L10.83,12L15.41,7.41L14,6L8,12L14,18L15.41,16.58Z" Width="12" Height="12" Foreground="{DynamicResource TextPrimaryBrush}"/>
                     </Button>
                     <Button Click="OnNextClick" Width="32" Height="32" CornerRadius="16" Background="#20FFFFFF" BorderThickness="1" BorderBrush="#40FFFFFF" ToolTip.Tip="Next">
                         <PathIcon Data="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" Width="12" Height="12" Foreground="{DynamicResource TextPrimaryBrush}"/>
                     </Button>
                 </StackPanel>

                 <!-- Right: Hidden Logic & Close (Draggable) -->
                 <Grid Grid.Column="2" PointerPressed="OnHeaderPointerPressed" Background="Transparent">
                     <StackPanel Orientation="Horizontal" IsVisible="False" HorizontalAlignment="Right" Margin="0,0,50,0">
                          <NumericUpDown x:Name="ZoomControl" Minimum="0.2" Maximum="5.0" Increment="0.1" Value="1.0" Width="80" FormatString="0.0x"/>
                          <Button Click="OnRotateClick" Content="Rotate"/>
                     </StackPanel>
                     
                     <Button Click="OnCloseClick" VerticalAlignment="Top" HorizontalAlignment="Right" Content="âœ•" Width="40" Height="30" Background="Transparent" BorderThickness="0" Margin="0,0,5,0" Foreground="{DynamicResource TextPrimaryBrush}"/>
                 </Grid>
            </Grid>

            <!-- Content -->
            <Grid Grid.Row="1" ColumnDefinitions="*, 2, *" Margin="10">
                <!-- Original -->
                <Grid Grid.Column="0" RowDefinitions="*, Auto">
                    <Border BorderBrush="#40FFFFFF" BorderThickness="1" Background="#10000000" CornerRadius="4" ClipToBounds="True">
                        <Grid>
                            <ScrollViewer Name="SvOriginal" HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto"
                                          PointerPressed="OnImagePointerPressed" PointerMoved="OnImagePointerMoved" PointerReleased="OnImagePointerReleased">
                                 <LayoutTransformControl>
                                     <LayoutTransformControl.LayoutTransform>
                                         <TransformGroup>
                                             <ScaleTransform ScaleX="{Binding #ZoomControl.Value}" ScaleY="{Binding #ZoomControl.Value}"/>
                                             <RotateTransform Angle="{Binding $parent[views:PreviewWindow].RotationOriginal}" />
                                         </TransformGroup>
                                     </LayoutTransformControl.LayoutTransform>
                                     <Image Name="ImgOriginal" Stretch="None" Margin="5"/>
                                 </LayoutTransformControl>
                            </ScrollViewer>
                            <!-- Rotate Button Overlay -->
                            <Button Click="OnRotateOriginalClick" HorizontalAlignment="Right" VerticalAlignment="Top" Margin="10" 
                                    Background="#80000000" CornerRadius="4" Padding="4" BorderThickness="0" ToolTip.Tip="Rotate Original">
                                <PathIcon Data="M12,4C14.2,4 16.2,4.8 17.6,6.3C20.7,9.4 20.7,14.5 17.6,17.6C15.8,19.5 13.3,20.2 11,19.9V21.9C13.9,22.2 16.9,21.2 19.1,19C23,15.1 23,8.9 19,5C17.1,3.1 14.5,2.1 12,2V0L7,4L12,8V4Z" 
                                          Width="14" Height="14" Foreground="White">
                                     <PathIcon.RenderTransform>
                                         <RotateTransform Angle="90"/>
                                     </PathIcon.RenderTransform>
                                </PathIcon>
                            </Button>
                        </Grid>
                    </Border>
                    <TextBlock Grid.Row="1" Text="Original" HorizontalAlignment="Center" Margin="0,5,0,0" FontWeight="Bold" Foreground="{DynamicResource TextPrimaryBrush}"/>
                </Grid>

                <!-- Separator -->
                <GridSplitter Grid.Column="1" Width="2" Background="#40808080" ResizeBehavior="PreviousAndNext"/>

                <!-- Result -->
                <Grid Grid.Column="2" RowDefinitions="*, Auto">
                    <Border BorderBrush="#40FFFFFF" BorderThickness="1" Background="#10000000" CornerRadius="4" ClipToBounds="True">
                        <Grid>
                           <ScrollViewer Name="SvResult" HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto"
                                         PointerPressed="OnImagePointerPressed" PointerMoved="OnImagePointerMoved" PointerReleased="OnImagePointerReleased">
                                 <LayoutTransformControl>
                                     <LayoutTransformControl.LayoutTransform>
                                         <TransformGroup>
                                             <ScaleTransform ScaleX="{Binding #ZoomControl.Value}" ScaleY="{Binding #ZoomControl.Value}"/>
                                              <RotateTransform Angle="{Binding $parent[views:PreviewWindow].RotationResult}"/>
                                         </TransformGroup>
                                     </LayoutTransformControl.LayoutTransform>
                                     <Image Name="ImgResult" Stretch="None" Margin="5"/>
                                 </LayoutTransformControl>
                            </ScrollViewer>
                            <!-- Rotate Button Overlay -->
                            <Button Click="OnRotateResultClick" HorizontalAlignment="Right" VerticalAlignment="Top" Margin="10" 
                                    Background="#80000000" CornerRadius="4" Padding="4" BorderThickness="0" ToolTip.Tip="Rotate Result">
                                <PathIcon Data="M12,4C14.2,4 16.2,4.8 17.6,6.3C20.7,9.4 20.7,14.5 17.6,17.6C15.8,19.5 13.3,20.2 11,19.9V21.9C13.9,22.2 16.9,21.2 19.1,19C23,15.1 23,8.9 19,5C17.1,3.1 14.5,2.1 12,2V0L7,4L12,8V4Z" 
                                          Width="14" Height="14" Foreground="White">
                                     <PathIcon.RenderTransform>
                                         <RotateTransform Angle="90"/>
                                     </PathIcon.RenderTransform>
                                </PathIcon>
                            </Button>
                        </Grid>
                    </Border>
                    <TextBlock Grid.Row="1" Text="Result" HorizontalAlignment="Center" Margin="0,5,0,0" FontWeight="Bold" Foreground="{DynamicResource TextPrimaryBrush}"/>
                </Grid>
            </Grid>
        </Grid>
    </Border>
    
    <Window.Styles>
        <Style Selector="Button:pointerover /template/ ContentPresenter">
             <Setter Property="Foreground" Value="Red"/>
        </Style>
    </Window.Styles>
</Window>
